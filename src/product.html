<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalles del Producto | autentikapp</title>
    <link rel="icon" type="image/webp" href="/identidad/logotipo-oficial.webp">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/date-fns@2.28.0/esm/index.js"></script>
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background: #ffffff;
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 0, 0, 0.05);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }
        .luxury-button {
            background: linear-gradient(135deg, #000000 0%, #1a1a1a 100%);
            transition: all 0.3s ease;
        }
        .luxury-button:hover {
            background: linear-gradient(135deg, #1a1a1a 0%, #333333 100%);
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }
        .filter-input {
            background: rgba(0, 0, 0, 0.02);
            border: 1px solid rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
        }
        .filter-input:focus {
            background: rgba(0, 0, 0, 0.03);
            border-color: rgba(0, 0, 0, 0.15);
            box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.05);
        }
    </style>
</head>
<body class="bg-white text-gray-900 flex">

    <div id="sidebar-placeholder"></div>

    <!-- Main Content -->
    <main class="flex-1 p-8 bg-white transition-all duration-300">
        <!-- Header -->
        <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-8">
            <div class="flex items-center">
                <button onclick="goBack()" class="mr-4 p-2 text-gray-400 hover:text-gray-600 transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                    </svg>
                </button>
                <div>
                    <h1 id="product-title" class="text-4xl font-light text-gray-900 mb-2">Cargando...</h1>
                    <p class="text-lg text-gray-500 font-light">Gestión completa del producto</p>
                </div>
            </div>
            <div class="flex space-x-3 mt-4 md:mt-0">
                <button id="edit-product-btn" class="px-6 py-3 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-xl font-medium transition-colors">
                    Editar Producto
                </button>
                <button id="generate-batch-btn" class="luxury-button px-6 py-3 text-white rounded-xl font-medium">
                    + Generar Lote
                </button>
            </div>
        </div>

        <!-- Product Info Card -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
            <!-- Product Display -->
            <div id="product-info" class="lg:col-span-2 glass-card rounded-2xl p-8">
                <!-- Product Tabs -->
                <div class="mb-8">
                    <nav class="flex space-x-1 bg-gray-50 p-1 rounded-xl">
                        <button class="product-tab active px-4 py-3 text-sm font-medium rounded-lg bg-white text-gray-900 shadow-sm" data-tab="overview">Resumen</button>
                        <button class="product-tab px-4 py-3 text-sm font-medium rounded-lg text-gray-500 hover:text-gray-900 hover:bg-white transition-all" data-tab="manufacturer">Fabricante</button>
                        <button class="product-tab px-4 py-3 text-sm font-medium rounded-lg text-gray-500 hover:text-gray-900 hover:bg-white transition-all" data-tab="materials">Materiales</button>
                        <button class="product-tab px-4 py-3 text-sm font-medium rounded-lg text-gray-500 hover:text-gray-900 hover:bg-white transition-all" data-tab="care">Cuidado</button>
                        <button class="product-tab px-4 py-3 text-sm font-medium rounded-lg text-gray-500 hover:text-gray-900 hover:bg-white transition-all" data-tab="sustainability">Sostenibilidad</button>
                    </nav>
                </div>
                <div id="product-tab-content">
                    <!-- Content will be loaded here -->
                </div>
            </div>
            
            <!-- Product Edit Form -->
            <div id="product-edit-form" class="glass-card rounded-2xl p-8 hidden">
                <h3 class="text-2xl font-light text-gray-900 mb-6">Editar Producto</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Nombre del Producto</label>
                        <input type="text" id="edit-name" class="filter-input w-full px-4 py-3 text-gray-900 rounded-xl focus:outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Color</label>
                        <input type="text" id="edit-color" class="filter-input w-full px-4 py-3 text-gray-900 rounded-xl focus:outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Material</label>
                        <input type="text" id="edit-material" class="filter-input w-full px-4 py-3 text-gray-900 rounded-xl focus:outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Tipo</label>
                        <input type="text" id="edit-type" class="filter-input w-full px-4 py-3 text-gray-900 rounded-xl focus:outline-none">
                    </div>
                    <div class="flex space-x-4 pt-6">
                        <button id="save-changes-btn" class="flex-1 luxury-button text-white px-6 py-3 rounded-xl font-medium">
                            Guardar
                        </button>
                        <button id="cancel-edit-btn" class="flex-1 px-6 py-3 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-xl font-medium transition-colors">
                            Cancelar
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Stats Cards -->
        <div id="product-stats" class="grid grid-cols-2 md:grid-cols-4 gap-6 mb-8">
            <!-- Stats will be loaded here -->
        </div>

        <!-- Enhanced Search and Filters -->
        <div class="glass-card rounded-2xl p-6 mb-8">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-lg font-medium text-gray-900">Búsqueda y Filtros</h3>
                <button id="toggle-filters" class="text-gray-500 hover:text-gray-700 text-sm font-light">
                    Ocultar
                </button>
            </div>
            <div id="filters-content" class="space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
                    <input type="text" id="search-ids" placeholder="Buscar por ID o cliente..."
                           class="filter-input px-4 py-3 text-gray-900 rounded-xl focus:outline-none">
                    <select id="filter-status" class="filter-input px-4 py-3 text-gray-900 rounded-xl focus:outline-none">
                        <option value="all">Todos los estados</option>
                        <option value="claimed">Reclamados</option>
                        <option value="unclaimed">Disponibles</option>
                    </select>
                    <select id="filter-time" class="filter-input px-4 py-3 text-gray-900 rounded-xl focus:outline-none">
                        <option value="all">Todas las fechas</option>
                        <option value="today">Hoy</option>
                        <option value="week">Esta semana</option>
                        <option value="month">Este mes</option>
                    </select>
                    <input type="date" id="date-from" placeholder="Desde" 
                           class="filter-input px-4 py-3 text-gray-900 rounded-xl focus:outline-none">
                    <select id="sort-ids" class="filter-input px-4 py-3 text-gray-900 rounded-xl focus:outline-none">
                        <option value="id">Ordenar por ID</option>
                        <option value="date">Ordenar por fecha creación</option>
                        <option value="claimed">Ordenar por fecha reclamo</option>
                        <option value="status">Ordenar por estado</option>
                    </select>
                </div>
                
                <div class="flex items-center justify-between pt-4 border-t border-gray-100">
                    <div id="filter-summary" class="text-sm text-gray-500 font-light">
                        Mostrando todos los IDs
                    </div>
                    <div class="flex space-x-3">
                        <button id="clear-filters" class="px-4 py-2 text-sm bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg transition-colors">
                            Limpiar
                        </button>
                        <button id="apply-filters" class="luxury-button px-4 py-2 text-sm text-white rounded-lg">
                            Aplicar
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Batches Section -->
        <div class="mb-8">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-light text-gray-900">Lotes de IDs</h3>
                <select id="view-mode" class="filter-input px-4 py-3 text-gray-900 rounded-xl focus:outline-none">
                    <option value="batches">Ver por Lotes</option>
                    <option value="ids">Ver Todos los IDs</option>
                </select>
            </div>
            
            <!-- Batches View -->
            <div id="batches-view" class="glass-card rounded-2xl shadow-sm overflow-hidden">
                <div class="px-8 py-6 border-b border-gray-100">
                    <h4 class="text-xl font-light text-gray-900">Lotes Generados</h4>
                </div>
                <div id="batches-container">
                    <!-- Batches will be loaded here -->
                </div>
            </div>
        </div>

        <!-- IDs Table -->
        <div id="ids-view" class="glass-card rounded-2xl shadow-sm overflow-hidden hidden">
            <div class="px-8 py-6 border-b border-gray-100">
                <h3 class="text-xl font-light text-gray-900">Todos los IDs del Producto</h3>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-100">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID Seguro</th>
                            <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Lote</th>
                            <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estado</th>
                            <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cliente</th>
                            <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha Creación</th>
                            <th class="px-6 py-4 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="ids-table-body" class="bg-white divide-y divide-gray-50">
                        <!-- Rows will be inserted here -->
                    </tbody>
                </table>
            </div>
            <div id="no-ids-message" class="p-8 text-center text-gray-500 hidden">No se encontraron códigos.</div>
        </div>
    </main>

    <!-- Client Profile Modal -->
    <div id="client-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="glass-card rounded-3xl p-8 w-full max-w-4xl max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-8">
                <div>
                    <h2 class="text-3xl font-light text-gray-900">Perfil del Cliente</h2>
                    <p class="text-gray-500 font-light">Información completa y historial</p>
                </div>
                <button id="close-client-modal" class="text-gray-400 hover:text-gray-600 transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div id="client-profile-content">
                <!-- Client profile content will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Generate Batch Modal -->
    <div id="batch-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="glass-card rounded-3xl p-8 w-full max-w-md">
            <h2 class="text-3xl font-light text-gray-900 mb-4">Generar Nuevo Lote</h2>
            <p class="text-gray-500 font-light mb-8">Crea un lote de IDs seguros para este producto.</p>
            
            <div class="space-y-4">
                <div class="bg-gray-50 p-4 rounded-xl">
                    <p class="text-sm text-gray-500">Producto:</p>
                    <p id="batch-product-name" class="font-semibold text-gray-900"></p>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Cantidad de IDs</label>
                    <input type="number" id="batch-quantity" min="1" max="100" value="10" 
                           class="filter-input w-full px-4 py-3 text-gray-900 rounded-xl focus:outline-none">
                    <p class="text-xs text-gray-500 mt-1">Máximo 100 IDs por lote</p>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Descripción del Lote (Opcional)</label>
                    <input type="text" id="batch-description" placeholder="Ej: Producción Enero 2025" 
                           class="filter-input w-full px-4 py-3 text-gray-900 rounded-xl focus:outline-none">
                </div>
                
                <div class="bg-green-50 border border-green-200 rounded-xl p-4">
                    <div class="flex items-start">
                        <svg class="w-5 h-5 text-green-600 mr-3 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.25-4.5a12.002 12.002 0 01-.1 5.75m-.65 5.25a12.002 12.002 0 01-5.75-.1m-5.25-.65a12.002 12.002 0 01-.1-5.75m.65-5.25a12.002 12.002 0 015.75.1"></path>
                        </svg>
                        <div>
                            <p class="text-sm text-green-800 font-medium">Seguridad Nivel 3</p>
                            <p class="text-xs text-green-700 mt-1">Los IDs generados usarán encriptación SHA-256 y serán irrepetibles.</p>
                        </div>
                    </div>
                </div>
                
                <button id="confirm-batch-btn" class="w-full luxury-button text-white px-6 py-3 rounded-xl font-medium">
                    Generar Lote Seguro
                </button>
            </div>
            
            <button id="close-batch-modal" class="mt-6 text-gray-500 hover:text-gray-700 text-sm w-full text-center transition-colors">Cancelar</button>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed top-5 right-5 bg-gray-900 text-white py-3 px-6 rounded-xl shadow-lg hidden z-50">
        <span id="toast-message">Acción completada</span>
    </div>

    <script type="module" src="./js/loadSidebar.js"></script>
    <script type="module">
        import { parseISO, format } from 'https://cdn.jsdelivr.net/npm/date-fns@2.28.0/esm/index.js';

        let productData = null;
        let allItems = [];
        let clientsData = {};
        let batches = [];
        let currentViewMode = 'batches';
        
        // Secure ID Generation (Level 3)
        async function generateSecureID(productName, clientCode = 'WM') {
            const year = new Date().getFullYear();
            const timestamp = Date.now();
            const random = Math.random().toString(36).substring(2, 8).toUpperCase();
            
            // Create unique string for hashing
            const uniqueString = `${productName}-${clientCode}-${timestamp}-${random}-${Math.random()}`;
            
            // Generate SHA-256 hash
            const encoder = new TextEncoder();
            const data = encoder.encode(uniqueString);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            
            // Take first 8 characters of hash for readability
            const secureHash = hashHex.substring(0, 8).toUpperCase();
            
            return `AUT-${year}-${clientCode}-${secureHash}`;
        }

        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const productName = urlParams.get('name');

            if (!productName) {
                document.getElementById('product-title').textContent = 'Producto no encontrado';
                return;
            }

            loadProductData(productName);
            setupEventListeners();
            setupEditFunctionality();
            setupBatchSystem();
        });

        function loadProductData(productName) {
            fetch('business.json')
                .then(response => response.json())
                .then(data => {
                    productData = data.products.find(p => p.productName === productName);
                    clientsData = data.clients.reduce((acc, client) => {
                        acc[client.id] = client;
                        return acc;
                    }, {});

                    if (!productData) {
                        document.getElementById('product-title').textContent = 'Producto no encontrado';
                        return;
                    }

                    allItems = productData.items.map(item => ({
                        ...item,
                        client: clientsData[item.ownerId] || null
                    }));
                    
                    // Group items into batches
                    batches = groupItemsIntoBatches(allItems);

                    renderProductInfo();
                    renderProductStats();
                    renderBatchesView();
                    renderItemsTable(allItems);
                })
                .catch(error => {
                    console.error("Error al cargar los datos:", error);
                    document.getElementById('product-title').textContent = 'Error al cargar el producto';
                });
        }

        function renderProductInfo() {
            document.getElementById('product-title').textContent = productData.productName;
            showProductTab('overview');
            setupProductTabs();
        }

        function setupProductTabs() {
            document.querySelectorAll('.product-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabName = tab.dataset.tab;
                    showProductTab(tabName);
                });
            });
        }

        function showProductTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.product-tab').forEach(tab => {
                tab.classList.remove('active', 'bg-white', 'text-gray-900', 'shadow-sm');
                tab.classList.add('text-gray-500');
            });
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active', 'bg-white', 'text-gray-900', 'shadow-sm');
            document.querySelector(`[data-tab="${tabName}"]`).classList.remove('text-gray-500');

            // Show tab content
            const content = document.getElementById('product-tab-content');
            switch(tabName) {
                case 'overview':
                    content.innerHTML = getOverviewTabContent();
                    break;
                case 'manufacturer':
                    content.innerHTML = getManufacturerTabContent();
                    break;
                case 'materials':
                    content.innerHTML = getMaterialsTabContent();
                    break;
                case 'care':
                    content.innerHTML = getCareTabContent();
                    break;
                case 'sustainability':
                    content.innerHTML = getSustainabilityTabContent();
                    break;
            }
        }

        function getOverviewTabContent() {
            return `
                <div class="flex flex-col md:flex-row gap-6">
                    <img src="${productData.productImage}" alt="${productData.productName}" 
                         class="w-32 h-32 rounded-lg object-cover">
                    <div class="flex-1">
                        <h2 class="text-2xl font-bold mb-4">${productData.productName}</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <span class="text-gray-400">Color:</span>
                                <span class="ml-2 font-semibold">${productData.details?.color || 'N/A'}</span>
                            </div>
                            <div>
                                <span class="text-gray-400">Material:</span>
                                <span class="ml-2 font-semibold">${productData.details?.material || 'N/A'}</span>
                            </div>
                            <div>
                                <span class="text-gray-400">Tipo:</span>
                                <span class="ml-2 font-semibold">${productData.details?.tipo || 'N/A'}</span>
                            </div>
                            <div>
                                <span class="text-gray-400">Total IDs:</span>
                                <span class="ml-2 font-semibold">${allItems.length}</span>
                            </div>
                        </div>
                        <div class="mt-4 p-4 bg-gray-800 rounded-lg">
                            <h4 class="text-sm font-medium text-gray-300 mb-2">Descripción</h4>
                            <p class="text-sm text-gray-400">Producto auténtico con códigos QR únicos para verificación de autenticidad. Cada unidad cuenta con un identificador irrepetible que garantiza su originalidad.</p>
                            ${productData.warrantyPolicy ? `
                                <div class="mt-3 pt-3 border-t border-gray-700">
                                    <a href="${productData.warrantyPolicy}" target="_blank" 
                                       class="inline-flex items-center text-blue-400 hover:text-blue-300 text-sm font-medium">
                                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                        </svg>
                                        Ver Política de Garantía
                                    </a>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        function getManufacturerTabContent() {
            const manufacturer = productData.manufacturer || {};
            return `
                <div class="space-y-6">
                    <div class="flex items-center space-x-4">
                        <div class="w-16 h-16 bg-blue-600 rounded-lg flex items-center justify-center">
                            <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                            </svg>
                        </div>
                        <div>
                            <h3 class="text-xl font-bold">${manufacturer.name || 'N/A'}</h3>
                            <p class="text-gray-400">${manufacturer.city || 'N/A'}, ${manufacturer.country || 'N/A'}</p>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="space-y-4">
                            <div>
                                <span class="text-gray-400">Fundado en:</span>
                                <span class="ml-2 font-semibold">${manufacturer.established || 'N/A'}</span>
                            </div>
                            <div>
                                <span class="text-gray-400">Empleados:</span>
                                <span class="ml-2 font-semibold">${manufacturer.employees || 'N/A'}</span>
                            </div>
                            <div>
                                <span class="text-gray-400">Teléfono:</span>
                                <span class="ml-2 font-semibold">${manufacturer.contact?.phone || 'N/A'}</span>
                            </div>
                            <div>
                                <span class="text-gray-400">Email:</span>
                                <span class="ml-2 font-semibold">${manufacturer.contact?.email || 'N/A'}</span>
                            </div>
                            ${manufacturer.contact?.website ? `
                                <div>
                                    <a href="${manufacturer.contact.website}" target="_blank" class="text-blue-400 hover:text-blue-300">Visitar sitio web</a>
                                </div>
                            ` : ''}
                        </div>
                        
                        <div>
                            <h4 class="text-lg font-semibold mb-3">Certificaciones</h4>
                            <div class="space-y-2">
                                ${(manufacturer.certifications || []).map(cert => `
                                    <div class="flex items-center">
                                        <svg class="w-4 h-4 text-green-400 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                        <span class="text-sm">${cert}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function getMaterialsTabContent() {
            const materials = productData.materials || {};
            return `
                <div class="space-y-6">
                    <div>
                        <h3 class="text-lg font-semibold mb-3">Material Principal</h3>
                        <p class="text-gray-300">${materials.primary || 'N/A'}</p>
                    </div>
                    
                    <div>
                        <h3 class="text-lg font-semibold mb-3">Materiales Secundarios</h3>
                        <div class="space-y-2">
                            ${(materials.secondary || []).map(material => `
                                <div class="flex items-center">
                                    <svg class="w-4 h-4 text-blue-400 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                    </svg>
                                    <span class="text-sm">${material}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <h4 class="text-lg font-semibold mb-3">Certificaciones</h4>
                            <div class="space-y-2">
                                ${(materials.certifications || []).map(cert => `
                                    <div class="flex items-center">
                                        <svg class="w-4 h-4 text-green-400 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                        <span class="text-sm">${cert}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <div>
                            <h4 class="text-lg font-semibold mb-3">Durabilidad</h4>
                            <p class="text-sm text-gray-300">${materials.durability || 'N/A'}</p>
                            
                            <h4 class="text-lg font-semibold mb-3 mt-4">Origen</h4>
                            <p class="text-sm text-gray-300">${materials.origin || 'N/A'}</p>
                        </div>
                    </div>
                </div>
            `;
        }

        function getCareTabContent() {
            const care = productData.care || {};
            return `
                <div class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <h3 class="text-lg font-semibold mb-3 text-green-400">Recomendaciones de Uso</h3>
                            <div class="space-y-2">
                                ${(care.usage?.recommendations || []).map(rec => `
                                    <div class="flex items-start">
                                        <svg class="w-4 h-4 text-green-400 mr-2 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                        <span class="text-sm">${rec}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <div>
                            <h3 class="text-lg font-semibold mb-3 text-red-400">Advertencias</h3>
                            <div class="space-y-2">
                                ${(care.usage?.warnings || []).map(warning => `
                                    <div class="flex items-start">
                                        <svg class="w-4 h-4 text-red-400 mr-2 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                                        </svg>
                                        <span class="text-sm">${warning}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <h3 class="text-lg font-semibold mb-4">Guía de Mantenimiento</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="bg-gray-800 p-4 rounded-lg">
                                <h4 class="font-semibold text-blue-400 mb-2">Cuidado Diario</h4>
                                <p class="text-sm text-gray-300">${care.maintenance?.daily || 'N/A'}</p>
                            </div>
                            <div class="bg-gray-800 p-4 rounded-lg">
                                <h4 class="font-semibold text-blue-400 mb-2">Cuidado Semanal</h4>
                                <p class="text-sm text-gray-300">${care.maintenance?.weekly || 'N/A'}</p>
                            </div>
                            <div class="bg-gray-800 p-4 rounded-lg">
                                <h4 class="font-semibold text-blue-400 mb-2">Cuidado Mensual</h4>
                                <p class="text-sm text-gray-300">${care.maintenance?.monthly || 'N/A'}</p>
                            </div>
                            <div class="bg-gray-800 p-4 rounded-lg">
                                <h4 class="font-semibold text-blue-400 mb-2">Almacenamiento</h4>
                                <p class="text-sm text-gray-300">${care.maintenance?.storage || 'N/A'}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <h3 class="text-lg font-semibold mb-4">Servicios de Reparación Autorizados</h3>
                        <div class="space-y-4">
                            ${(care.repair?.authorized || []).map(shop => `
                                <div class="bg-gray-800 p-4 rounded-lg">
                                    <div class="flex justify-between items-start mb-2">
                                        <h4 class="font-semibold">${shop.name}</h4>
                                        <div class="flex items-center">
                                            <svg class="w-4 h-4 text-yellow-400 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                                <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
                                            </svg>
                                            <span class="text-sm">${shop.rating}</span>
                                        </div>
                                    </div>
                                    <p class="text-sm text-gray-400 mb-2">${shop.address}</p>
                                    <div class="flex flex-wrap gap-2 mb-2">
                                        ${shop.services.map(service => `
                                            <span class="px-2 py-1 bg-blue-900 text-blue-300 text-xs rounded">${service}</span>
                                        `).join('')}
                                    </div>
                                    <div class="flex justify-between text-sm">
                                        <span class="text-gray-400">${shop.hours}</span>
                                        <a href="tel:${shop.phone}" class="text-blue-400 hover:text-blue-300">${shop.phone}</a>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        
                        <div class="mt-4 p-4 bg-gray-800 rounded-lg">
                            <h4 class="font-semibold mb-2">Información de Garantía</h4>
                            <p class="text-sm text-gray-300 mb-2"><strong>Cobertura:</strong> ${care.repair?.warranty || 'N/A'}</p>
                            <p class="text-sm text-gray-300"><strong>Repuestos:</strong> ${care.repair?.parts || 'N/A'}</p>
                        </div>
                    </div>
                </div>
            `;
        }

        function getSustainabilityTabContent() {
            const sustainability = productData.sustainability || {};
            return `
                <div class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-green-900 bg-opacity-20 p-4 rounded-lg border border-green-700">
                            <div class="flex items-center mb-3">
                                <svg class="w-6 h-6 text-green-400 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                <h3 class="text-lg font-semibold text-green-400">Impacto Ambiental</h3>
                            </div>
                            <p class="text-sm text-gray-300">${sustainability.environmental || 'N/A'}</p>
                        </div>
                        
                        <div class="bg-blue-900 bg-opacity-20 p-4 rounded-lg border border-blue-700">
                            <div class="flex items-center mb-3">
                                <svg class="w-6 h-6 text-blue-400 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                                </svg>
                                <h3 class="text-lg font-semibold text-blue-400">Impacto Social</h3>
                            </div>
                            <p class="text-sm text-gray-300">${sustainability.social || 'N/A'}</p>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="bg-gray-800 p-4 rounded-lg">
                            <h4 class="font-semibold text-purple-400 mb-2">Reciclaje</h4>
                            <p class="text-sm text-gray-300">${sustainability.recycling || 'N/A'}</p>
                        </div>
                        <div class="bg-gray-800 p-4 rounded-lg">
                            <h4 class="font-semibold text-orange-400 mb-2">Huella de Carbono</h4>
                            <p class="text-sm text-gray-300">${sustainability.carbon || 'N/A'}</p>
                        </div>
                        <div class="bg-gray-800 p-4 rounded-lg">
                            <h4 class="font-semibold text-cyan-400 mb-2">Empaque</h4>
                            <p class="text-sm text-gray-300">${sustainability.packaging || 'N/A'}</p>
                        </div>
                    </div>
                    
                    <div>
                        <h3 class="text-lg font-semibold mb-4">Certificaciones Ambientales</h3>
                        <div class="space-y-2">
                            ${(sustainability.certifications || []).map(cert => `
                                <div class="flex items-center">
                                    <svg class="w-4 h-4 text-green-400 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                    <span class="text-sm">${cert}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderProductStats() {
            const totalItems = allItems.length;
            const claimedItems = allItems.filter(item => item.ownerId).length;
            const availableItems = totalItems - claimedItems;
            const claimedPercentage = totalItems > 0 ? Math.round((claimedItems / totalItems) * 100) : 0;

            document.getElementById('product-stats').innerHTML = `
                <div class="glass-card rounded-2xl p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-500">Total IDs</p>
                            <p class="text-3xl font-light text-gray-900">${totalItems}</p>
                        </div>
                        <div class="w-12 h-12 bg-gray-100 rounded-xl flex items-center justify-center">
                            <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 20l4-16m2 16l4-16M6 9h14M4 15h14"></path>
                            </svg>
                        </div>
                    </div>
                </div>
                <div class="glass-card rounded-2xl p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-500">Verificados</p>
                            <p class="text-3xl font-light text-gray-900">${claimedItems}</p>
                        </div>
                        <div class="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center">
                            <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                    </div>
                </div>
                <div class="glass-card rounded-2xl p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-500">Disponibles</p>
                            <p class="text-3xl font-light text-gray-900">${availableItems}</p>
                        </div>
                        <div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center">
                            <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                            </svg>
                        </div>
                    </div>
                </div>
                <div class="glass-card rounded-2xl p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-500">Tasa Verificación</p>
                            <p class="text-3xl font-light text-gray-900">${claimedPercentage}%</p>
                        </div>
                        <div class="w-12 h-12 bg-purple-100 rounded-xl flex items-center justify-center">
                            <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                            </svg>
                        </div>
                    </div>
                </div>
            `;
        }

        function groupItemsIntoBatches(items) {
            const batchMap = {};
            items.forEach(item => {
                const batchId = item.batchId || 'default';
                if (!batchMap[batchId]) {
                    batchMap[batchId] = {
                        id: batchId,
                        items: [],
                        createdAt: item.createdAt || new Date().toISOString(),
                        description: item.batchDescription || 'Lote sin descripción'
                    };
                }
                batchMap[batchId].items.push(item);
            });
            return Object.values(batchMap);
        }

        function renderBatchesView() {
            const container = document.getElementById('batches-container');
            if (batches.length === 0) {
                container.innerHTML = `
                    <div class="p-8 text-center text-gray-500">
                        <svg class="w-12 h-12 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 009.586 13H7"></path>
                        </svg>
                        <p class="font-light">No hay lotes generados para este producto</p>
                        <button onclick="openBatchModal()" class="mt-4 luxury-button px-6 py-3 text-white rounded-xl font-medium">
                            Generar Primer Lote
                        </button>
                    </div>
                `;
                return;
            }

            container.innerHTML = batches.map(batch => {
                const claimedCount = batch.items.filter(item => item.ownerId).length;
                const availableCount = batch.items.length - claimedCount;
                const claimedPercentage = Math.round((claimedCount / batch.items.length) * 100);
                
                return `
                    <div class="border-b border-gray-100 last:border-b-0">
                        <div class="px-8 py-6 hover:bg-gray-50 transition-colors cursor-pointer" onclick="toggleBatchDetails('${batch.id}')">
                            <div class="flex items-center justify-between">
                                <div class="flex-1">
                                    <div class="flex items-center space-x-4">
                                        <div class="w-12 h-12 bg-gray-100 rounded-xl flex items-center justify-center">
                                            <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 009.586 13H7"></path>
                                            </svg>
                                        </div>
                                        <div>
                                            <h4 class="text-lg font-medium text-gray-900">Lote ${batch.id}</h4>
                                            <p class="text-sm text-gray-500">${batch.description}</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="flex items-center space-x-6">
                                    <div class="text-center">
                                        <p class="text-2xl font-light text-gray-900">${batch.items.length}</p>
                                        <p class="text-xs text-gray-500">Total IDs</p>
                                    </div>
                                    <div class="text-center">
                                        <p class="text-2xl font-light text-green-600">${claimedCount}</p>
                                        <p class="text-xs text-gray-500">Verificados</p>
                                    </div>
                                    <div class="text-center">
                                        <p class="text-2xl font-light text-blue-600">${availableCount}</p>
                                        <p class="text-xs text-gray-500">Disponibles</p>
                                    </div>
                                    <div class="text-center">
                                        <p class="text-2xl font-light text-purple-600">${claimedPercentage}%</p>
                                        <p class="text-xs text-gray-500">Tasa</p>
                                    </div>
                                    <svg class="w-5 h-5 text-gray-400 transform transition-transform batch-chevron-${batch.id}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                    </svg>
                                </div>
                            </div>
                        </div>
                        <div id="batch-details-${batch.id}" class="hidden px-8 pb-6">
                            <div class="bg-gray-50 rounded-xl p-6">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <h5 class="font-medium text-gray-900 mb-3">Información del Lote</h5>
                                        <div class="space-y-2 text-sm">
                                            <div class="flex justify-between">
                                                <span class="text-gray-500">Fecha de creación:</span>
                                                <span class="text-gray-900">${format(parseISO(batch.createdAt), 'dd/MM/yyyy HH:mm')}</span>
                                            </div>
                                            <div class="flex justify-between">
                                                <span class="text-gray-500">Nivel de seguridad:</span>
                                                <span class="text-gray-900">Nivel 3 (SHA-256)</span>
                                            </div>
                                            <div class="flex justify-between">
                                                <span class="text-gray-500">Estado del lote:</span>
                                                <span class="text-gray-900">${availableCount > 0 ? 'Activo' : 'Completado'}</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div>
                                        <h5 class="font-medium text-gray-900 mb-3">IDs del Lote</h5>
                                        <div class="max-h-32 overflow-y-auto space-y-1">
                                            ${batch.items.slice(0, 5).map(item => `
                                                <div class="flex items-center justify-between text-sm">
                                                    <span class="font-mono text-gray-600">${item.id}</span>
                                                    <span class="px-2 py-1 rounded-full text-xs ${
                                                        item.ownerId ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800'
                                                    }">
                                                        ${item.ownerId ? 'Verificado' : 'Disponible'}
                                                    </span>
                                                </div>
                                            `).join('')}
                                            ${batch.items.length > 5 ? `
                                                <div class="text-xs text-gray-500 text-center pt-2">
                                                    ... y ${batch.items.length - 5} IDs más
                                                </div>
                                            ` : ''}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function toggleBatchDetails(batchId) {
            const details = document.getElementById(`batch-details-${batchId}`);
            const chevron = document.querySelector(`.batch-chevron-${batchId}`);
            
            if (details.classList.contains('hidden')) {
                details.classList.remove('hidden');
                chevron.style.transform = 'rotate(180deg)';
            } else {
                details.classList.add('hidden');
                chevron.style.transform = 'rotate(0deg)';
            }
        }

        function renderItemsTable(items) {
            const tbody = document.getElementById('ids-table-body');
            const noItemsMessage = document.getElementById('no-ids-message');
            
            if (items.length === 0) {
                tbody.innerHTML = '';
                noItemsMessage.classList.remove('hidden');
                return;
            }
            
            noItemsMessage.classList.add('hidden');
            tbody.innerHTML = items.map(item => {
                const client = item.client;
                const statusClass = item.ownerId ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800';
                const statusText = item.ownerId ? 'Verificado' : 'Disponible';
                
                return `
                    <tr class="hover:bg-gray-50 cursor-pointer transition-colors" onclick="showItemDetails('${item.id}')">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="font-mono text-sm text-gray-900">${item.id}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-900">${item.batchId || 'default'}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">
                                ${statusText}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-900">
                                ${client ? client.name : 'Sin asignar'}
                            </div>
                            ${client ? `<div class="text-sm text-gray-500">${client.email}</div>` : ''}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            ${format(parseISO(item.createdAt || new Date().toISOString()), 'dd/MM/yyyy')}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button onclick="event.stopPropagation(); copyToClipboard('${item.id}')" 
                                    class="text-gray-400 hover:text-gray-600 mr-3">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                </svg>
                            </button>
                            <button onclick="event.stopPropagation(); window.open('https://autentikapp.vercel.app/producto?id=${item.id}', '_blank')" 
                                    class="text-gray-400 hover:text-gray-600">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                                </svg>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function showItemDetails(itemId) {
            const item = allItems.find(i => i.id === itemId);
            if (!item) return;
            
            const client = item.client;
            const batch = batches.find(b => b.id === item.batchId);
            
            const modalContent = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div>
                        <h3 class="text-xl font-medium text-gray-900 mb-6">Información del ID</h3>
                        <div class="space-y-4">
                            <div class="bg-gray-50 p-4 rounded-xl">
                                <p class="text-sm text-gray-500 mb-1">ID Seguro</p>
                                <p class="font-mono text-lg text-gray-900">${item.id}</p>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <p class="text-sm text-gray-500 mb-1">Estado</p>
                                    <span class="px-3 py-1 rounded-full text-sm ${
                                        item.ownerId ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800'
                                    }">
                                        ${item.ownerId ? 'Verificado' : 'Disponible'}
                                    </span>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500 mb-1">Lote</p>
                                    <p class="text-gray-900">${item.batchId || 'default'}</p>
                                </div>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500 mb-1">Fecha de Creación</p>
                                <p class="text-gray-900">${format(parseISO(item.createdAt || new Date().toISOString()), 'dd/MM/yyyy HH:mm')}</p>
                            </div>
                            ${item.claimedAt ? `
                                <div>
                                    <p class="text-sm text-gray-500 mb-1">Fecha de Verificación</p>
                                    <p class="text-gray-900">${format(parseISO(item.claimedAt), 'dd/MM/yyyy HH:mm')}</p>
                                </div>
                            ` : ''}
                            <div class="pt-4 border-t border-gray-200">
                                <p class="text-sm text-gray-500 mb-2">URL de Verificación</p>
                                <div class="flex items-center space-x-2">
                                    <input type="text" value="https://autentikapp.vercel.app/producto?id=${item.id}" 
                                           class="flex-1 px-3 py-2 bg-gray-50 border border-gray-200 rounded-lg text-sm font-mono" readonly>
                                    <button onclick="copyToClipboard('https://autentikapp.vercel.app/producto?id=${item.id}')" 
                                            class="px-3 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        ${client ? `
                            <h3 class="text-xl font-medium text-gray-900 mb-6">Cliente Propietario</h3>
                            <div class="space-y-4">
                                <div class="flex items-center space-x-4">
                                    <div class="w-16 h-16 bg-gradient-to-br from-blue-500 to-purple-600 rounded-xl flex items-center justify-center">
                                        <span class="text-white font-semibold text-lg">${client.name.charAt(0)}</span>
                                    </div>
                                    <div>
                                        <h4 class="text-lg font-medium text-gray-900">${client.name}</h4>
                                        <p class="text-gray-500">${client.email}</p>
                                    </div>
                                </div>
                                <div class="grid grid-cols-1 gap-4">
                                    <div>
                                        <p class="text-sm text-gray-500 mb-1">Teléfono</p>
                                        <p class="text-gray-900">${client.phone || 'No disponible'}</p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-500 mb-1">Ubicación</p>
                                        <p class="text-gray-900">${client.location || 'No disponible'}</p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-500 mb-1">Segmento</p>
                                        <span class="px-3 py-1 rounded-full text-sm bg-purple-100 text-purple-800">
                                            ${client.segment || 'General'}
                                        </span>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-500 mb-1">Cliente desde</p>
                                        <p class="text-gray-900">${format(parseISO(client.registrationDate || new Date().toISOString()), 'dd/MM/yyyy')}</p>
                                    </div>
                                </div>
                            </div>
                        ` : `
                            <div class="text-center py-12">
                                <svg class="w-16 h-16 mx-auto text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                </svg>
                                <h3 class="text-lg font-medium text-gray-900 mb-2">ID Disponible</h3>
                                <p class="text-gray-500">Este ID aún no ha sido verificado por ningún cliente.</p>
                            </div>
                        `}
                    </div>
                </div>
                
                ${batch ? `
                    <div class="mt-8 pt-8 border-t border-gray-200">
                        <h3 class="text-xl font-medium text-gray-900 mb-4">Información del Lote</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div class="bg-gray-50 p-4 rounded-xl">
                                <p class="text-sm text-gray-500 mb-1">Lote ID</p>
                                <p class="font-semibold text-gray-900">${batch.id}</p>
                            </div>
                            <div class="bg-gray-50 p-4 rounded-xl">
                                <p class="text-sm text-gray-500 mb-1">Total IDs en Lote</p>
                                <p class="font-semibold text-gray-900">${batch.items.length}</p>
                            </div>
                            <div class="bg-gray-50 p-4 rounded-xl">
                                <p class="text-sm text-gray-500 mb-1">IDs Verificados</p>
                                <p class="font-semibold text-gray-900">${batch.items.filter(i => i.ownerId).length}</p>
                            </div>
                        </div>
                        <div class="mt-4">
                            <p class="text-sm text-gray-500 mb-1">Descripción del Lote</p>
                            <p class="text-gray-900">${batch.description}</p>
                        </div>
                    </div>
                ` : ''}
            `;
            
            document.getElementById('client-profile-content').innerHTML = modalContent;
            document.getElementById('client-modal').classList.remove('hidden');
        }

        function setupEventListeners() {
            // View mode toggle
            document.getElementById('view-mode').addEventListener('change', (e) => {
                currentViewMode = e.target.value;
                if (currentViewMode === 'batches') {
                    document.getElementById('batches-view').classList.remove('hidden');
                    document.getElementById('ids-view').classList.add('hidden');
                } else {
                    document.getElementById('batches-view').classList.add('hidden');
                    document.getElementById('ids-view').classList.remove('hidden');
                }
            });

            // Filter toggle
            document.getElementById('toggle-filters').addEventListener('click', () => {
                const content = document.getElementById('filters-content');
                const button = document.getElementById('toggle-filters');
                if (content.classList.contains('hidden')) {
                    content.classList.remove('hidden');
                    button.textContent = 'Ocultar';
                } else {
                    content.classList.add('hidden');
                    button.textContent = 'Mostrar';
                }
            });

            // Search and filter functionality
            document.getElementById('search-ids').addEventListener('input', applyFilters);
            document.getElementById('filter-status').addEventListener('change', applyFilters);
            document.getElementById('filter-time').addEventListener('change', applyFilters);
            document.getElementById('date-from').addEventListener('change', applyFilters);
            document.getElementById('sort-ids').addEventListener('change', applyFilters);
            
            document.getElementById('clear-filters').addEventListener('click', clearFilters);
            document.getElementById('apply-filters').addEventListener('click', applyFilters);

            // Modal close buttons
            document.getElementById('close-client-modal').addEventListener('click', () => {
                document.getElementById('client-modal').classList.add('hidden');
            });
        }

        function applyFilters() {
            const searchTerm = document.getElementById('search-ids').value.toLowerCase();
            const statusFilter = document.getElementById('filter-status').value;
            const timeFilter = document.getElementById('filter-time').value;
            const dateFrom = document.getElementById('date-from').value;
            const sortBy = document.getElementById('sort-ids').value;

            let filteredItems = [...allItems];

            // Apply search filter
            if (searchTerm) {
                filteredItems = filteredItems.filter(item => 
                    item.id.toLowerCase().includes(searchTerm) ||
                    (item.client && item.client.name.toLowerCase().includes(searchTerm))
                );
            }

            // Apply status filter
            if (statusFilter !== 'all') {
                filteredItems = filteredItems.filter(item => {
                    if (statusFilter === 'claimed') return item.ownerId;
                    if (statusFilter === 'unclaimed') return !item.ownerId;
                    return true;
                });
            }

            // Apply time filter
            if (timeFilter !== 'all') {
                const now = new Date();
                const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
                const monthAgo = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000);

                filteredItems = filteredItems.filter(item => {
                    const itemDate = new Date(item.createdAt || new Date());
                    if (timeFilter === 'today') return itemDate >= today;
                    if (timeFilter === 'week') return itemDate >= weekAgo;
                    if (timeFilter === 'month') return itemDate >= monthAgo;
                    return true;
                });
            }

            // Apply date from filter
            if (dateFrom) {
                const fromDate = new Date(dateFrom);
                filteredItems = filteredItems.filter(item => {
                    const itemDate = new Date(item.createdAt || new Date());
                    return itemDate >= fromDate;
                });
            }

            // Apply sorting
            filteredItems.sort((a, b) => {
                switch (sortBy) {
                    case 'id':
                        return a.id.localeCompare(b.id);
                    case 'date':
                        return new Date(b.createdAt || new Date()) - new Date(a.createdAt || new Date());
                    case 'claimed':
                        return new Date(b.claimedAt || 0) - new Date(a.claimedAt || 0);
                    case 'status':
                        return (b.ownerId ? 1 : 0) - (a.ownerId ? 1 : 0);
                    default:
                        return 0;
                }
            });

            renderItemsTable(filteredItems);
            updateFilterSummary(filteredItems.length, allItems.length);
        }

        function clearFilters() {
            document.getElementById('search-ids').value = '';
            document.getElementById('filter-status').value = 'all';
            document.getElementById('filter-time').value = 'all';
            document.getElementById('date-from').value = '';
            document.getElementById('sort-ids').value = 'id';
            renderItemsTable(allItems);
            updateFilterSummary(allItems.length, allItems.length);
        }

        function updateFilterSummary(filtered, total) {
            const summary = document.getElementById('filter-summary');
            if (filtered === total) {
                summary.textContent = `Mostrando todos los ${total} IDs`;
            } else {
                summary.textContent = `Mostrando ${filtered} de ${total} IDs`;
            }
        }

        function setupEditFunctionality() {
            document.getElementById('edit-product-btn').addEventListener('click', () => {
                document.getElementById('product-info').classList.add('hidden');
                document.getElementById('product-edit-form').classList.remove('hidden');
                
                // Populate form with current data
                document.getElementById('edit-name').value = productData.productName;
                document.getElementById('edit-color').value = productData.details?.color || '';
                document.getElementById('edit-material').value = productData.details?.material || '';
                document.getElementById('edit-type').value = productData.details?.tipo || '';
            });

            document.getElementById('cancel-edit-btn').addEventListener('click', () => {
                document.getElementById('product-info').classList.remove('hidden');
                document.getElementById('product-edit-form').classList.add('hidden');
            });

            document.getElementById('save-changes-btn').addEventListener('click', () => {
                // Here you would normally save to backend
                showToast('Cambios guardados correctamente');
                document.getElementById('product-info').classList.remove('hidden');
                document.getElementById('product-edit-form').classList.add('hidden');
            });
        }

        function setupBatchSystem() {
            document.getElementById('generate-batch-btn').addEventListener('click', openBatchModal);
            document.getElementById('close-batch-modal').addEventListener('click', closeBatchModal);
            document.getElementById('confirm-batch-btn').addEventListener('click', generateBatch);
        }

        function openBatchModal() {
            document.getElementById('batch-product-name').textContent = productData.productName;
            document.getElementById('batch-modal').classList.remove('hidden');
        }

        function closeBatchModal() {
            document.getElementById('batch-modal').classList.add('hidden');
            document.getElementById('batch-quantity').value = '10';
            document.getElementById('batch-description').value = '';
        }

        async function generateBatch() {
            const quantity = parseInt(document.getElementById('batch-quantity').value);
            const description = document.getElementById('batch-description').value || `Lote generado el ${format(new Date(), 'dd/MM/yyyy')}`;
            
            if (quantity < 1 || quantity > 100) {
                showToast('La cantidad debe estar entre 1 y 100 IDs', 'error');
                return;
            }

            const batchId = `BATCH-${Date.now()}`;
            const newItems = [];
            
            showToast('Generando lote seguro...', 'info');
            
            for (let i = 0; i < quantity; i++) {
                const secureId = await generateSecureID(productData.productName);
                newItems.push({
                    id: secureId,
                    batchId: batchId,
                    batchDescription: description,
                    createdAt: new Date().toISOString(),
                    ownerId: null,
                    claimedAt: null,
                    client: null
                });
            }
            
            // Add to allItems and update batches
            allItems.push(...newItems);
            batches = groupItemsIntoBatches(allItems);
            
            // Re-render everything
            renderProductStats();
            renderBatchesView();
            renderItemsTable(allItems);
            
            closeBatchModal();
            showToast(`Lote de ${quantity} IDs generado correctamente`, 'success');
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showToast('Copiado al portapapeles');
            });
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toast-message');
            
            toastMessage.textContent = message;
            
            // Update toast styling based on type
            toast.className = 'fixed top-5 right-5 py-3 px-6 rounded-xl shadow-lg z-50';
            if (type === 'success') {
                toast.classList.add('bg-green-600', 'text-white');
            } else if (type === 'error') {
                toast.classList.add('bg-red-600', 'text-white');
            } else if (type === 'info') {
                toast.classList.add('bg-blue-600', 'text-white');
            } else {
                toast.classList.add('bg-gray-900', 'text-white');
            }
            
            toast.classList.remove('hidden');
            
            setTimeout(() => {
                toast.classList.add('hidden');
            }, 3000);
        }

        function goBack() {
            window.history.back();
        }

        // Make functions globally available
        window.toggleBatchDetails = toggleBatchDetails;
        window.showItemDetails = showItemDetails;
        window.copyToClipboard = copyToClipboard;
        window.openBatchModal = openBatchModal;
        window.goBack = goBack;
    </script>
</body>
</html>
                            <p class="text-sm text-gray-300">${sustainability.packaging || 'N/A'}</p>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderProductStats() {
            const totalItems = allItems.length;
            const claimedItems = allItems.filter(item => item.status === 'Claimed').length;
            const availableItems = totalItems - claimedItems;
            const claimRate = totalItems > 0 ? ((claimedItems / totalItems) * 100).toFixed(1) : 0;
            const secureIds = allItems.filter(item => item.id.startsWith('AUT-')).length;
            const totalBatches = batches.length;

            const statsContainer = document.getElementById('product-stats');
            statsContainer.innerHTML = `
                <div class="glass-card rounded-2xl p-6 text-center hover:shadow-lg transition-all">
                    <h4 class="text-gray-500 text-sm font-medium uppercase tracking-wider">Total IDs</h4>
                    <p class="text-3xl font-light text-gray-900 mt-2">${totalItems}</p>
                    <p class="text-xs text-gray-400 mt-1">${secureIds} seguros</p>
                </div>
                <div class="glass-card rounded-2xl p-6 text-center hover:shadow-lg transition-all">
                    <h4 class="text-gray-500 text-sm font-medium uppercase tracking-wider">Lotes Activos</h4>
                    <p class="text-3xl font-light text-gray-900 mt-2">${totalBatches}</p>
                    <p class="text-xs text-gray-400 mt-1">Generados</p>
                </div>
                <div class="glass-card rounded-2xl p-6 text-center hover:shadow-lg transition-all">
                    <h4 class="text-gray-500 text-sm font-medium uppercase tracking-wider">Reclamados</h4>
                    <p class="text-3xl font-light text-green-600 mt-2">${claimedItems}</p>
                    <p class="text-xs text-gray-400 mt-1">${availableItems} disponibles</p>
                </div>
                <div class="glass-card rounded-2xl p-6 text-center hover:shadow-lg transition-all">
                    <h4 class="text-gray-500 text-sm font-medium uppercase tracking-wider">Tasa de Uso</h4>
                    <p class="text-3xl font-light text-gray-900 mt-2">${claimRate}%</p>
                    <p class="text-xs text-gray-400 mt-1">Efectividad</p>
                </div>
            `;
        }

        function renderItemsTable(items) {
            const tableBody = document.getElementById('ids-table-body');
            const noItemsMessage = document.getElementById('no-ids-message');

            if (items.length === 0) {
                tableBody.innerHTML = '';
                noItemsMessage.classList.remove('hidden');
                return;
            }

            noItemsMessage.classList.add('hidden');
            tableBody.innerHTML = items.map(item => {
                const creationDate = item.creationDate ? format(parseISO(item.creationDate), 'dd/MM/yyyy') : 'N/A';
                const claimedDate = item.claimedDate ? format(parseISO(item.claimedDate), 'dd/MM/yyyy') : '-';
                
                const isSecureId = item.id.startsWith('AUT-');
                const batchInfo = item.batchDescription || 'Lote heredado';
                const claimedDate = item.claimedDate ? format(parseISO(item.claimedDate), 'dd/MM/yyyy') : '-';
                
                return `
                    <tr class="hover:bg-gray-50 transition-colors cursor-pointer" onclick="showIdDetails('${item.id}')">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <span class="font-mono text-sm text-gray-900">${item.id}</span>
                                ${isSecureId ? `
                                    <span class="ml-2 px-2 py-1 bg-green-100 text-green-700 text-xs rounded-full">
                                        <svg class="w-3 h-3 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.25-4.5a12.002 12.002 0 01-.1 5.75m-.65 5.25a12.002 12.002 0 01-5.75-.1m-5.25-.65a12.002 12.002 0 01-.1-5.75m.65-5.25a12.002 12.002 0 015.75.1"></path>
                                        </svg>
                                        Seguro
                                    </span>
                                ` : `
                                    <span class="ml-2 px-2 py-1 bg-yellow-100 text-yellow-700 text-xs rounded-full">
                                        Heredado
                                    </span>
                                `}
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm">
                                <div class="font-medium text-gray-900">${batchInfo}</div>
                                <div class="text-xs text-gray-500">${item.batchId || 'N/A'}</div>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-3 py-1 text-xs rounded-full font-medium ${
                                item.status === 'Claimed' 
                                    ? 'bg-green-100 text-green-700' 
                                    : 'bg-blue-100 text-blue-700'
                            }">
                                ${item.status === 'Claimed' ? 'Reclamado' : 'Disponible'}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            ${item.client ? `
                                <button onclick="event.stopPropagation(); showClientProfile('${item.client.id}')" 
                                        class="text-blue-600 hover:text-blue-800 hover:underline font-medium">
                                    ${item.client.name}
                                </button>
                                <div class="text-xs text-gray-500 mt-1">Reclamado: ${claimedDate}</div>
                            ` : '<span class="text-gray-400 font-light">Sin asignar</span>'}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${creationDate}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <div class="flex justify-end space-x-2">
                                <button onclick="event.stopPropagation(); viewQR('${item.id}')" 
                                        class="luxury-button text-white px-3 py-1 rounded-lg text-xs">
                                    Ver QR
                                </button>
                                <button onclick="event.stopPropagation(); copyIdToClipboard('${item.id}')" 
                                        class="px-3 py-1 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg text-xs transition-colors">
                                    Copiar
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function setupEventListeners() {
            const searchInput = document.getElementById('search-ids');
            const filterStatus = document.getElementById('filter-status');
            const filterTime = document.getElementById('filter-time');
            const dateFrom = document.getElementById('date-from');
            const sortIds = document.getElementById('sort-ids');
            const closeClientModal = document.getElementById('close-client-modal');
            const toggleFilters = document.getElementById('toggle-filters');
            const clearFilters = document.getElementById('clear-filters');
            const applyFilters = document.getElementById('apply-filters');

            searchInput.addEventListener('input', filterItems);
            filterStatus.addEventListener('change', filterItems);
            filterTime.addEventListener('change', filterItems);
            dateFrom.addEventListener('change', filterItems);
            sortIds.addEventListener('change', filterItems);
            clearFilters.addEventListener('click', clearAllFilters);
            applyFilters.addEventListener('click', filterItems);
            toggleFilters.addEventListener('click', toggleFiltersPanel);
            closeClientModal.addEventListener('click', () => {
                document.getElementById('client-modal').classList.add('hidden');
            });
        }
        
        function toggleFiltersPanel() {
            const content = document.getElementById('filters-content');
            const button = document.getElementById('toggle-filters');
            
            if (content.classList.contains('hidden')) {
                content.classList.remove('hidden');
                button.textContent = 'Ocultar';
            } else {
                content.classList.add('hidden');
                button.textContent = 'Mostrar';
            }
        }
        
        function clearAllFilters() {
            document.getElementById('search-ids').value = '';
            document.getElementById('filter-status').value = 'all';
            document.getElementById('filter-time').value = 'all';
            document.getElementById('date-from').value = '';
            document.getElementById('sort-ids').value = 'id';
            filterItems();
        }
        
        function updateFilterSummary(count) {
            const summary = document.getElementById('filter-summary');
            const total = allItems.length;
            
            if (count === total) {
                summary.textContent = `Mostrando todos los ${total} IDs`;
            } else {
                summary.textContent = `Mostrando ${count} de ${total} IDs`;
            }
        }

        function setupEditFunctionality() {
            const editBtn = document.getElementById('edit-product-btn');
            const saveBtn = document.getElementById('save-changes-btn');
            const cancelBtn = document.getElementById('cancel-edit-btn');

            editBtn.addEventListener('click', toggleEditMode);
            saveBtn.addEventListener('click', saveProductChanges);
            cancelBtn.addEventListener('click', cancelEdit);
        }
        
        function setupBatchSystem() {
            const generateBatchBtn = document.getElementById('generate-batch-btn');
            const closeBatchModal = document.getElementById('close-batch-modal');
            const confirmBatchBtn = document.getElementById('confirm-batch-btn');
            const viewModeSelect = document.getElementById('view-mode');
            
            generateBatchBtn.addEventListener('click', showBatchModal);
            closeBatchModal.addEventListener('click', () => {
                document.getElementById('batch-modal').classList.add('hidden');
            });
            confirmBatchBtn.addEventListener('click', generateNewBatch);
            viewModeSelect.addEventListener('change', switchViewMode);
        }

        function toggleEditMode() {
            const editForm = document.getElementById('product-edit-form');
            const productInfo = document.getElementById('product-info');
            
            if (editForm.classList.contains('hidden')) {
                // Show edit form
                editForm.classList.remove('hidden');
                productInfo.classList.add('lg:col-span-1');
                productInfo.classList.remove('lg:col-span-2');
                
                // Populate form with current data
                document.getElementById('edit-name').value = productData.productName;
                document.getElementById('edit-color').value = productData.details?.color || '';
                document.getElementById('edit-material').value = productData.details?.material || '';
                document.getElementById('edit-type').value = productData.details?.tipo || '';
            } else {
                cancelEdit();
            }
        }

        function cancelEdit() {
            const editForm = document.getElementById('product-edit-form');
            const productInfo = document.getElementById('product-info');
            
            editForm.classList.add('hidden');
            productInfo.classList.remove('lg:col-span-1');
            productInfo.classList.add('lg:col-span-2');
        }

        function saveProductChanges() {
            const newName = document.getElementById('edit-name').value;
            const newColor = document.getElementById('edit-color').value;
            const newMaterial = document.getElementById('edit-material').value;
            const newType = document.getElementById('edit-type').value;

            productData.productName = newName;
            productData.details = {
                color: newColor,
                material: newMaterial,
                tipo: newType
            };

            renderProductInfo();
            cancelEdit();
            showToast('Producto actualizado exitosamente');
        }

        function showBatchModal() {
            document.getElementById('batch-product-name').textContent = productData.productName;
            document.getElementById('batch-modal').classList.remove('hidden');
        }
        
        function groupItemsIntoBatches(items) {
            const batchMap = new Map();
            
            items.forEach(item => {
                // Extract batch info from ID or create default batch
                const batchId = item.batchId || 'LEGACY-BATCH';
                
                if (!batchMap.has(batchId)) {
                    batchMap.set(batchId, {
                        id: batchId,
                        description: item.batchDescription || 'Lote heredado',
                        creationDate: item.batchCreationDate || item.creationDate,
                        items: [],
                        totalCount: 0,
                        claimedCount: 0,
                        availableCount: 0
                    });
                }
                
                const batch = batchMap.get(batchId);
                batch.items.push(item);
                batch.totalCount++;
                
                if (item.status === 'Claimed') {
                    batch.claimedCount++;
                } else {
                    batch.availableCount++;
                }
            });
            
            return Array.from(batchMap.values());
        }
        
        async function generateNewBatch() {
            const quantity = parseInt(document.getElementById('batch-quantity').value);
            const description = document.getElementById('batch-description').value || `Lote ${new Date().toLocaleDateString()}`;
            
            if (quantity < 1 || quantity > 100) {
                showToast('La cantidad debe estar entre 1 y 100', 'error');
                return;
            }
            
            const batchId = `BATCH-${Date.now()}`;
            const creationDate = new Date().toISOString().split('T')[0];
            const newItems = [];
            
            // Show loading state
            document.getElementById('confirm-batch-btn').textContent = 'Generando...';
            document.getElementById('confirm-batch-btn').disabled = true;
            
            try {
                // Generate secure IDs
                for (let i = 0; i < quantity; i++) {
                    const secureId = await generateSecureID(productData.productName);
                    
                    const newItem = {
                        id: secureId,
                        status: 'Unclaimed',
                        ownerId: null,
                        claimedDate: null,
                        creationDate: creationDate,
                        batchId: batchId,
                        batchDescription: description,
                        batchCreationDate: creationDate,
                        client: null
                    };
                    
                    newItems.push(newItem);
                    allItems.push(newItem);
                }
                
                // Update batches
                batches = groupItemsIntoBatches(allItems);
                
                // Re-render views
                renderProductStats();
                renderBatchesView();
                renderItemsTable(allItems);
                
                document.getElementById('batch-modal').classList.add('hidden');
                showToast(`Lote generado exitosamente: ${quantity} IDs seguros creados`, 'success');
                
            } catch (error) {
                console.error('Error generating batch:', error);
                showToast('Error al generar el lote', 'error');
            } finally {
                document.getElementById('confirm-batch-btn').textContent = 'Generar Lote Seguro';
                document.getElementById('confirm-batch-btn').disabled = false;
            }
        }
        
        function renderBatchesView() {
            const container = document.getElementById('batches-container');
            
            if (batches.length === 0) {
                container.innerHTML = '<div class="p-8 text-center text-gray-500 font-light">No hay lotes generados</div>';
                return;
            }
            
            container.innerHTML = batches.map(batch => {
                const claimRate = batch.totalCount > 0 ? ((batch.claimedCount / batch.totalCount) * 100).toFixed(1) : 0;
                
                return `
                    <div class="border-b border-gray-100 last:border-b-0">
                        <div class="p-8">
                            <div class="flex justify-between items-start mb-6">
                                <div>
                                    <h4 class="text-xl font-medium text-gray-900">${batch.description}</h4>
                                    <p class="text-sm text-gray-500 mt-1">ID: ${batch.id}</p>
                                    <p class="text-sm text-gray-500">Creado: ${format(parseISO(batch.creationDate), 'dd/MM/yyyy')}</p>
                                </div>
                                <div class="text-right">
                                    <div class="text-3xl font-light text-gray-900">${batch.totalCount}</div>
                                    <div class="text-sm text-gray-500 font-light">IDs totales</div>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-3 gap-4 mb-6">
                                <div class="bg-green-50 border border-green-200 p-4 rounded-xl text-center">
                                    <div class="text-2xl font-light text-green-600">${batch.claimedCount}</div>
                                    <div class="text-xs text-green-700 font-medium uppercase tracking-wider">Reclamados</div>
                                </div>
                                <div class="bg-blue-50 border border-blue-200 p-4 rounded-xl text-center">
                                    <div class="text-2xl font-light text-blue-600">${batch.availableCount}</div>
                                    <div class="text-xs text-blue-700 font-medium uppercase tracking-wider">Disponibles</div>
                                </div>
                                <div class="bg-gray-50 border border-gray-200 p-4 rounded-xl text-center">
                                    <div class="text-2xl font-light text-gray-900">${claimRate}%</div>
                                    <div class="text-xs text-gray-600 font-medium uppercase tracking-wider">Tasa uso</div>
                                </div>
                            </div>
                            
                            <div class="flex justify-between items-center">
                                <div class="flex space-x-3">
                                    <button onclick="viewBatchDetails('${batch.id}')" 
                                            class="luxury-button text-white px-4 py-2 rounded-lg text-sm">
                                        Ver Detalles
                                    </button>
                                    <button onclick="downloadBatchQRs('${batch.id}')" 
                                            class="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg text-sm transition-colors">
                                        Descargar QRs
                                    </button>
                                </div>
                                <div class="w-32 bg-gray-200 rounded-full h-2">
                                    <div class="bg-green-500 h-2 rounded-full transition-all" style="width: ${claimRate}%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function switchViewMode() {
            const viewMode = document.getElementById('view-mode').value;
            const batchesView = document.getElementById('batches-view');
            const idsView = document.getElementById('ids-view');
            
            if (viewMode === 'batches') {
                batchesView.classList.remove('hidden');
                idsView.classList.add('hidden');
                currentViewMode = 'batches';
            } else {
                batchesView.classList.add('hidden');
                idsView.classList.remove('hidden');
                currentViewMode = 'ids';
            }
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toast-message');
            
            // Update toast styling based on type
            toast.className = `fixed top-5 right-5 py-2 px-4 rounded-lg shadow-lg z-50 ${
                type === 'error' ? 'bg-red-500' : 'bg-green-500'
            } text-white`;
            
            toastMessage.textContent = message;
            toast.classList.remove('hidden');
            
            setTimeout(() => {
                toast.classList.add('hidden');
            }, 4000);
        }
        
        function viewBatchDetails(batchId) {
            const batch = batches.find(b => b.id === batchId);
            if (!batch) return;
            
            // Switch to IDs view and filter by batch
            document.getElementById('view-mode').value = 'ids';
            switchViewMode();
            
            // Filter items by batch
            const batchItems = allItems.filter(item => item.batchId === batchId);
            renderItemsTable(batchItems);
            
            showToast(`Mostrando ${batchItems.length} IDs del lote: ${batch.description}`);
        }
        
        function downloadBatchQRs(batchId) {
            const batch = batches.find(b => b.id === batchId);
            if (!batch) return;
            
            // Create downloadable content
            const batchData = {
                batchId: batch.id,
                description: batch.description,
                creationDate: batch.creationDate,
                product: productData.productName,
                totalIds: batch.totalCount,
                ids: batch.items.map(item => ({
                    id: item.id,
                    qrUrl: `https://autentikapp.vercel.app/producto?id=${item.id}`,
                    status: item.status,
                    creationDate: item.creationDate
                }))
            };
            
            const dataStr = JSON.stringify(batchData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `lote-${batch.id}-${productData.productName.replace(/\s+/g, '-')}.json`;
            link.click();
            
            URL.revokeObjectURL(url);
            showToast(`Lote descargado: ${batch.totalCount} IDs`);
        }

        function filterItems() {
            const searchTerm = document.getElementById('search-ids').value.toLowerCase();
            const statusFilter = document.getElementById('filter-status').value;
            const timeFilter = document.getElementById('filter-time').value;
            const dateFrom = document.getElementById('date-from').value;
            const sortBy = document.getElementById('sort-ids').value;

            let filtered = allItems.filter(item => {
                const matchesSearch = item.id.toLowerCase().includes(searchTerm) ||
                                    (item.client && item.client.name.toLowerCase().includes(searchTerm));
                
                let matchesStatus = true;
                if (statusFilter === 'claimed') {
                    matchesStatus = item.status === 'Claimed';
                } else if (statusFilter === 'unclaimed') {
                    matchesStatus = item.status !== 'Claimed';
                }

                let matchesTime = true;
                if (item.creationDate) {
                    const creationDate = parseISO(item.creationDate);
                    const today = new Date();
                    
                    if (timeFilter === 'today') {
                        matchesTime = format(creationDate, 'yyyy-MM-dd') === format(today, 'yyyy-MM-dd');
                    } else if (timeFilter === 'week') {
                        const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
                        matchesTime = creationDate >= weekAgo;
                    } else if (timeFilter === 'month') {
                        const monthAgo = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000);
                        matchesTime = creationDate >= monthAgo;
                    }
                    
                    if (dateFrom) {
                        const fromDate = parseISO(dateFrom);
                        matchesTime = matchesTime && creationDate >= fromDate;
                    }
                }

                return matchesSearch && matchesStatus && matchesTime;
            });

            // Sort items
            filtered.sort((a, b) => {
                switch(sortBy) {
                    case 'id': return a.id.localeCompare(b.id);
                    case 'date': 
                        const dateA = a.creationDate ? parseISO(a.creationDate) : new Date(0);
                        const dateB = b.creationDate ? parseISO(b.creationDate) : new Date(0);
                        return dateB - dateA;
                    case 'claimed':
                        const claimedA = a.claimedDate ? parseISO(a.claimedDate) : new Date(0);
                        const claimedB = b.claimedDate ? parseISO(b.claimedDate) : new Date(0);
                        return claimedB - claimedA;
                    case 'status': return a.status.localeCompare(b.status);
                    default: return 0;
                }
            });

            updateFilterSummary(filtered.length);
            renderItemsTable(filtered);
        }

        function showClientProfile(clientId) {
            const client = clientsData[clientId];
            if (!client) return;

            const clientProducts = allItems.filter(item => item.ownerId === clientId);
            
            const profileContent = document.getElementById('client-profile-content');
            profileContent.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <h3 class="text-lg font-semibold mb-4">Información Personal</h3>
                        <div class="space-y-3">
                            <div><span class="text-gray-400">Nombre:</span> <span class="ml-2">${client.name}</span></div>
                            <div><span class="text-gray-400">Email:</span> <span class="ml-2">${client.email}</span></div>
                            <div><span class="text-gray-400">Teléfono:</span> <span class="ml-2">${client.phone}</span></div>
                            <div><span class="text-gray-400">Ciudad:</span> <span class="ml-2">${client.city}</span></div>
                            <div><span class="text-gray-400">País:</span> <span class="ml-2">${client.country}</span></div>
                            <div><span class="text-gray-400">Edad:</span> <span class="ml-2">${client.age} años</span></div>
                            <div><span class="text-gray-400">Segmento:</span> <span class="ml-2">${client.segment}</span></div>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold mb-4">Productos Reclamados</h3>
                        <div class="space-y-2 max-h-48 overflow-y-auto">
                            ${clientProducts.map(item => `
                                <div class="bg-gray-800 p-3 rounded">
                                    <div class="font-mono text-sm">${item.id}</div>
                                    <div class="text-xs text-gray-400">
                                        Reclamado: ${item.claimedDate ? format(parseISO(item.claimedDate), 'dd/MM/yyyy') : 'N/A'}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('client-modal').classList.remove('hidden');
        }

        function viewQR(itemId) {
            window.open(`verify.html?id=${itemId}`, '_blank');
        }

        function claimProduct(itemId) {
            window.open(`verify.html?id=${itemId}&claimed=true`, '_blank');
        }

        function goBack() {
            window.history.back();
        }

        // Make functions global for onclick handlers
        window.showClientProfile = showClientProfile;
        window.viewQR = viewQR;
        window.claimProduct = claimProduct;
        window.goBack = goBack;
        window.toggleEditMode = toggleEditMode;
        window.viewBatchDetails = viewBatchDetails;
        window.downloadBatchQRs = downloadBatchQRs;
        window.copyIdToClipboard = copyIdToClipboard;
        window.showIdDetails = showIdDetails;
        
        function copyIdToClipboard(id) {
            navigator.clipboard.writeText(id).then(() => {
                showToast(`ID copiado: ${id}`);
            }).catch(() => {
                showToast('Error al copiar ID', 'error');
            });
        }
        
        function showIdDetails(itemId) {
            const item = allItems.find(i => i.id === itemId);
            if (!item) return;
            
            const isSecureId = item.id.startsWith('AUT-');
            const claimedDate = item.claimedDate ? format(parseISO(item.claimedDate), 'dd/MM/yyyy HH:mm') : 'No reclamado';
            const creationDate = format(parseISO(item.creationDate), 'dd/MM/yyyy HH:mm');
            
            const profileContent = document.getElementById('client-profile-content');
            profileContent.innerHTML = `
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- ID Information -->
                    <div class="space-y-6">
                        <div class="bg-gray-50 rounded-2xl p-6">
                            <h3 class="text-lg font-medium text-gray-900 mb-4">Información del ID</h3>
                            <div class="space-y-4">
                                <div class="flex justify-between items-center">
                                    <span class="text-gray-500 font-light">Código ID:</span>
                                    <span class="font-mono text-gray-900 font-medium">${item.id}</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-gray-500 font-light">Tipo:</span>
                                    <span class="px-3 py-1 rounded-full text-xs font-medium ${
                                        isSecureId ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700'
                                    }">
                                        ${isSecureId ? 'ID Seguro (SHA-256)' : 'ID Heredado'}
                                    </span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-gray-500 font-light">Estado:</span>
                                    <span class="px-3 py-1 rounded-full text-xs font-medium ${
                                        item.status === 'Claimed' ? 'bg-green-100 text-green-700' : 'bg-blue-100 text-blue-700'
                                    }">
                                        ${item.status === 'Claimed' ? 'Reclamado' : 'Disponible'}
                                    </span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-gray-500 font-light">Fecha Creación:</span>
                                    <span class="text-gray-900 font-medium">${creationDate}</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-gray-500 font-light">Fecha Reclamo:</span>
                                    <span class="text-gray-900 font-medium">${claimedDate}</span>
                                </div>
                                ${item.batchId ? `
                                    <div class="flex justify-between items-center">
                                        <span class="text-gray-500 font-light">Lote:</span>
                                        <span class="text-gray-900 font-medium">${item.batchDescription || item.batchId}</span>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                        
                        <div class="bg-blue-50 rounded-2xl p-6">
                            <h3 class="text-lg font-medium text-blue-900 mb-4">URL de Verificación</h3>
                            <div class="bg-white rounded-lg p-4 border border-blue-200">
                                <p class="text-sm text-blue-800 font-mono break-all">
                                    https://autentikapp.vercel.app/producto?id=${item.id}
                                </p>
                                <button onclick="copyIdToClipboard('https://autentikapp.vercel.app/producto?id=${item.id}')" 
                                        class="mt-3 luxury-button text-white px-4 py-2 rounded-lg text-sm">
                                    Copiar URL
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Client Information -->
                    <div class="space-y-6">
                        ${item.client ? `
                            <div class="bg-green-50 rounded-2xl p-6">
                                <h3 class="text-lg font-medium text-green-900 mb-4">Cliente Asignado</h3>
                                <div class="space-y-4">
                                    <div class="flex justify-between items-center">
                                        <span class="text-green-700 font-light">Nombre:</span>
                                        <span class="text-green-900 font-medium">${item.client.name}</span>
                                    </div>
                                    <div class="flex justify-between items-center">
                                        <span class="text-green-700 font-light">Email:</span>
                                        <span class="text-green-900 font-medium">${item.client.email}</span>
                                    </div>
                                    <div class="flex justify-between items-center">
                                        <span class="text-green-700 font-light">Teléfono:</span>
                                        <span class="text-green-900 font-medium">${item.client.phone}</span>
                                    </div>
                                    <div class="flex justify-between items-center">
                                        <span class="text-green-700 font-light">Ubicación:</span>
                                        <span class="text-green-900 font-medium">${item.client.city}, ${item.client.country}</span>
                                    </div>
                                    <div class="flex justify-between items-center">
                                        <span class="text-green-700 font-light">Segmento:</span>
                                        <span class="text-green-900 font-medium">${item.client.segment}</span>
                                    </div>
                                </div>
                            </div>
                        ` : `
                            <div class="bg-gray-50 rounded-2xl p-6 text-center">
                                <div class="w-16 h-16 bg-gray-200 rounded-full flex items-center justify-center mx-auto mb-4">
                                    <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                    </svg>
                                </div>
                                <h3 class="text-lg font-medium text-gray-900 mb-2">Sin Cliente Asignado</h3>
                                <p class="text-gray-500 font-light">Este ID está disponible para ser reclamado por un cliente.</p>
                            </div>
                        `}
                        
                        <div class="bg-gray-50 rounded-2xl p-6">
                            <h3 class="text-lg font-medium text-gray-900 mb-4">Acciones</h3>
                            <div class="space-y-3">
                                <button onclick="viewQR('${item.id}')" class="w-full luxury-button text-white px-4 py-3 rounded-xl">
                                    Ver Código QR
                                </button>
                                <button onclick="copyIdToClipboard('${item.id}')" class="w-full px-4 py-3 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-xl transition-colors">
                                    Copiar ID
                                </button>
                                ${item.status !== 'Claimed' ? `
                                    <button onclick="claimProduct('${item.id}')" class="w-full px-4 py-3 bg-green-100 hover:bg-green-200 text-green-700 rounded-xl transition-colors">
                                        Marcar como Reclamado
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('client-modal').classList.remove('hidden');
        }
    </script>
</body>
</html>