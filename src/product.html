<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalles del Producto | autentikapp</title>
    <link rel="icon" type="image/webp" href="/identidad/logotipo-oficial.webp">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background: #ffffff;
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 0, 0, 0.05);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }
        .luxury-button {
            background: linear-gradient(135deg, #000000 0%, #1a1a1a 100%);
            transition: all 0.3s ease;
        }
        .luxury-button:hover {
            background: linear-gradient(135deg, #1a1a1a 0%, #333333 100%);
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }
        .filter-input {
            background: rgba(0, 0, 0, 0.02);
            border: 1px solid rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
        }
        .filter-input:focus {
            background: rgba(0, 0, 0, 0.03);
            border-color: rgba(0, 0, 0, 0.15);
            box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.05);
        }
    </style>
</head>
<body class="bg-white text-gray-900 flex">

    <div id="sidebar-placeholder"></div>

    <!-- Main Content -->
    <main class="flex-1 p-8 bg-white transition-all duration-300">
        <!-- Header -->
        <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-8">
            <div class="flex items-center">
                <button onclick="goBack()" class="mr-4 p-2 text-gray-400 hover:text-gray-600 transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                    </svg>
                </button>
                <div>
                    <h1 id="product-title" class="text-4xl font-light text-gray-900 mb-2">Cargando...</h1>
                    <p class="text-lg text-gray-500 font-light">Gestión completa del producto</p>
                </div>
            </div>
            <div class="flex space-x-3 mt-4 md:mt-0">
                <button id="edit-product-btn" class="px-6 py-3 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-xl font-medium transition-colors">
                    Editar Producto
                </button>
                <button id="generate-batch-btn" class="luxury-button px-6 py-3 text-white rounded-xl font-medium">
                    + Generar Lote
                </button>
            </div>
        </div>

        <!-- Product Info Card -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
            <!-- Product Display -->
            <div id="product-info" class="lg:col-span-2 glass-card rounded-2xl p-8">
                <!-- Product Tabs -->
                <div class="mb-8">
                    <nav class="flex space-x-1 bg-gray-50 p-1 rounded-xl">
                        <button class="product-tab active px-4 py-3 text-sm font-medium rounded-lg bg-white text-gray-900 shadow-sm" data-tab="overview">Resumen</button>
                        <button class="product-tab px-4 py-3 text-sm font-medium rounded-lg text-gray-500 hover:text-gray-900 hover:bg-white transition-all" data-tab="manufacturer">Fabricante</button>
                        <button class="product-tab px-4 py-3 text-sm font-medium rounded-lg text-gray-500 hover:text-gray-900 hover:bg-white transition-all" data-tab="materials">Materiales</button>
                        <button class="product-tab px-4 py-3 text-sm font-medium rounded-lg text-gray-500 hover:text-gray-900 hover:bg-white transition-all" data-tab="care">Cuidado</button>
                        <button class="product-tab px-4 py-3 text-sm font-medium rounded-lg text-gray-500 hover:text-gray-900 hover:bg-white transition-all" data-tab="sustainability">Sostenibilidad</button>
                    </nav>
                </div>
                <div id="product-tab-content">
                    <!-- Content will be loaded here -->
                </div>
            </div>
            
            <!-- Product Edit Form -->
            <div id="product-edit-form" class="glass-card rounded-2xl p-8 hidden">
                <h3 class="text-2xl font-light text-gray-900 mb-6">Editar Producto</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Nombre del Producto</label>
                        <input type="text" id="edit-name" class="filter-input w-full px-4 py-3 text-gray-900 rounded-xl focus:outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Color</label>
                        <input type="text" id="edit-color" class="filter-input w-full px-4 py-3 text-gray-900 rounded-xl focus:outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Material</label>
                        <input type="text" id="edit-material" class="filter-input w-full px-4 py-3 text-gray-900 rounded-xl focus:outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Tipo</label>
                        <input type="text" id="edit-type" class="filter-input w-full px-4 py-3 text-gray-900 rounded-xl focus:outline-none">
                    </div>
                    <div class="flex space-x-4 pt-6">
                        <button id="save-changes-btn" class="flex-1 luxury-button text-white px-6 py-3 rounded-xl font-medium">
                            Guardar
                        </button>
                        <button id="cancel-edit-btn" class="flex-1 px-6 py-3 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-xl font-medium transition-colors">
                            Cancelar
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Stats Cards -->
        <div id="product-stats" class="grid grid-cols-2 md:grid-cols-4 gap-6 mb-8">
            <!-- Stats will be loaded here -->
        </div>

        <!-- Enhanced Search and Filters -->
        <div class="glass-card rounded-2xl p-6 mb-8">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-lg font-medium text-gray-900">Búsqueda y Filtros</h3>
                <button id="toggle-filters" class="text-gray-500 hover:text-gray-700 text-sm font-light">
                    Ocultar
                </button>
            </div>
            <div id="filters-content" class="space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
                    <input type="text" id="search-ids" placeholder="Buscar por ID o cliente..."
                           class="filter-input px-4 py-3 text-gray-900 rounded-xl focus:outline-none">
                    <select id="filter-status" class="filter-input px-4 py-3 text-gray-900 rounded-xl focus:outline-none">
                        <option value="all">Todos los estados</option>
                        <option value="claimed">Reclamados</option>
                        <option value="unclaimed">Disponibles</option>
                    </select>
                    <select id="filter-time" class="filter-input px-4 py-3 text-gray-900 rounded-xl focus:outline-none">
                        <option value="all">Todas las fechas</option>
                        <option value="today">Hoy</option>
                        <option value="week">Esta semana</option>
                        <option value="month">Este mes</option>
                    </select>
                    <input type="date" id="date-from" placeholder="Desde" 
                           class="filter-input px-4 py-3 text-gray-900 rounded-xl focus:outline-none">
                    <select id="sort-ids" class="filter-input px-4 py-3 text-gray-900 rounded-xl focus:outline-none">
                        <option value="id">Ordenar por ID</option>
                        <option value="date">Ordenar por fecha creación</option>
                        <option value="claimed">Ordenar por fecha reclamo</option>
                        <option value="status">Ordenar por estado</option>
                    </select>
                </div>
                
                <div class="flex items-center justify-between pt-4 border-t border-gray-100">
                    <div id="filter-summary" class="text-sm text-gray-500 font-light">
                        Mostrando todos los IDs
                    </div>
                    <div class="flex space-x-3">
                        <button id="clear-filters" class="px-4 py-2 text-sm bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg transition-colors">
                            Limpiar
                        </button>
                        <button id="apply-filters" class="luxury-button px-4 py-2 text-sm text-white rounded-lg">
                            Aplicar
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Batches Section -->
        <div class="mb-8">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-light text-gray-900">Lotes de IDs</h3>
                <select id="view-mode" class="filter-input px-4 py-3 text-gray-900 rounded-xl focus:outline-none">
                    <option value="batches">Ver por Lotes</option>
                    <option value="ids">Ver Todos los IDs</option>
                </select>
            </div>
            
            <!-- Batches View -->
            <div id="batches-view" class="glass-card rounded-2xl shadow-sm overflow-hidden">
                <div class="px-8 py-6 border-b border-gray-100">
                    <h4 class="text-xl font-light text-gray-900">Lotes Generados</h4>
                </div>
                <div id="batches-container">
                    <!-- Batches will be loaded here -->
                </div>
            </div>
        </div>

        <!-- IDs Table -->
        <div id="ids-view" class="glass-card rounded-2xl shadow-sm overflow-hidden hidden">
            <div class="px-8 py-6 border-b border-gray-100">
                <h3 class="text-xl font-light text-gray-900">Todos los IDs del Producto</h3>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-100">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID Seguro</th>
                            <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Lote</th>
                            <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estado</th>
                            <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cliente</th>
                            <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha Creación</th>
                            <th class="px-6 py-4 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="ids-table-body" class="bg-white divide-y divide-gray-50">
                        <!-- Rows will be inserted here -->
                    </tbody>
                </table>
            </div>
            <div id="no-ids-message" class="p-8 text-center text-gray-500 hidden">No se encontraron códigos.</div>
        </div>
    </main>

    <!-- Generate Batch Modal -->
    <div id="batch-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="glass-card rounded-3xl p-8 w-full max-w-md">
            <h2 class="text-3xl font-light text-gray-900 mb-4">Generar Nuevo Lote</h2>
            <p class="text-gray-500 font-light mb-8">Crea un lote de IDs seguros para este producto.</p>
            
            <div class="space-y-4">
                <div class="bg-gray-50 p-4 rounded-xl">
                    <p class="text-sm text-gray-500">Producto:</p>
                    <p id="batch-product-name" class="font-semibold text-gray-900"></p>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Cantidad de IDs</label>
                    <input type="number" id="batch-quantity" min="1" max="100" value="10" 
                           class="filter-input w-full px-4 py-3 text-gray-900 rounded-xl focus:outline-none">
                    <p class="text-xs text-gray-500 mt-1">Máximo 100 IDs por lote</p>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Descripción del Lote (Opcional)</label>
                    <input type="text" id="batch-description" placeholder="Ej: Producción Enero 2025" 
                           class="filter-input w-full px-4 py-3 text-gray-900 rounded-xl focus:outline-none">
                </div>
                
                <div class="bg-green-50 border border-green-200 rounded-xl p-4">
                    <div class="flex items-start">
                        <svg class="w-5 h-5 text-green-600 mr-3 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.25-4.5a12.002 12.002 0 01-.1 5.75m-.65 5.25a12.002 12.002 0 01-5.75-.1m-5.25-.65a12.002 12.002 0 01-.1-5.75m.65-5.25a12.002 12.002 0 015.75.1"></path>
                        </svg>
                        <div>
                            <p class="text-sm text-green-800 font-medium">Seguridad Nivel 3</p>
                            <p class="text-xs text-green-700 mt-1">Los IDs generados usarán encriptación SHA-256 y serán irrepetibles.</p>
                        </div>
                    </div>
                </div>
                
                <button id="confirm-batch-btn" class="w-full luxury-button text-white px-6 py-3 rounded-xl font-medium">
                    Generar Lote Seguro
                </button>
            </div>
            
            <button id="close-batch-modal" class="mt-6 text-gray-500 hover:text-gray-700 text-sm w-full text-center transition-colors">Cancelar</button>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed top-5 right-5 bg-gray-900 text-white py-3 px-6 rounded-xl shadow-lg hidden z-50">
        <span id="toast-message">Acción completada</span>
    </div>

    <script type="module" src="./js/loadSidebar.js"></script>
    <script type="module">
        let productData = null;
        let allItems = [];
        let clientsData = {};
        let batches = [];
        let currentViewMode = 'batches';

        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const productName = urlParams.get('name');

            if (!productName) {
                document.getElementById('product-title').textContent = 'Producto no encontrado';
                return;
            }

            loadProductData(productName);
            setupEventListeners();
        });

        function loadProductData(productName) {
            fetch('business.json')
                .then(response => response.json())
                .then(data => {
                    productData = data.products.find(p => p.productName === productName);
                    clientsData = data.clients.reduce((acc, client) => {
                        acc[client.id] = client;
                        return acc;
                    }, {});

                    if (!productData) {
                        document.getElementById('product-title').textContent = 'Producto no encontrado';
                        return;
                    }

                    allItems = productData.items.map(item => ({
                        ...item,
                        client: clientsData[item.ownerId] || null
                    }));
                    
                    batches = groupItemsIntoBatches(allItems);

                    renderProductInfo();
                    renderProductStats();
                    renderBatchesView();
                    renderItemsTable(allItems);
                })
                .catch(error => {
                    console.error("Error al cargar los datos:", error);
                    document.getElementById('product-title').textContent = 'Error al cargar el producto';
                });
        }

        function renderProductInfo() {
            document.getElementById('product-title').textContent = productData.productName;
            showProductTab('overview');
            setupProductTabs();
        }

        function setupProductTabs() {
            document.querySelectorAll('.product-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabName = tab.dataset.tab;
                    showProductTab(tabName);
                });
            });
        }

        function showProductTab(tabName) {
            document.querySelectorAll('.product-tab').forEach(tab => {
                tab.classList.remove('active', 'bg-white', 'text-gray-900', 'shadow-sm');
                tab.classList.add('text-gray-500');
            });
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active', 'bg-white', 'text-gray-900', 'shadow-sm');
            document.querySelector(`[data-tab="${tabName}"]`).classList.remove('text-gray-500');

            const content = document.getElementById('product-tab-content');
            switch(tabName) {
                case 'overview':
                    content.innerHTML = getOverviewTabContent();
                    break;
                case 'manufacturer':
                    content.innerHTML = getManufacturerTabContent();
                    break;
                case 'materials':
                    content.innerHTML = getMaterialsTabContent();
                    break;
                case 'care':
                    content.innerHTML = getCareTabContent();
                    break;
                case 'sustainability':
                    content.innerHTML = getSustainabilityTabContent();
                    break;
            }
        }

        function getOverviewTabContent() {
            return `
                <div class="flex flex-col md:flex-row gap-6">
                    <img src="${productData.productImage}" alt="${productData.productName}" 
                         class="w-32 h-32 rounded-lg object-cover">
                    <div class="flex-1">
                        <h2 class="text-2xl font-light text-gray-900 mb-4">${productData.productName}</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <span class="text-gray-500">Color:</span>
                                <span class="ml-2 font-medium text-gray-900">${productData.details?.color || 'N/A'}</span>
                            </div>
                            <div>
                                <span class="text-gray-500">Material:</span>
                                <span class="ml-2 font-medium text-gray-900">${productData.details?.material || 'N/A'}</span>
                            </div>
                            <div>
                                <span class="text-gray-500">Tipo:</span>
                                <span class="ml-2 font-medium text-gray-900">${productData.details?.tipo || 'N/A'}</span>
                            </div>
                            <div>
                                <span class="text-gray-500">Total IDs:</span>
                                <span class="ml-2 font-medium text-gray-900">${allItems.length}</span>
                            </div>
                        </div>
                        <div class="mt-6 p-4 bg-gray-50 rounded-xl">
                            <h4 class="text-sm font-medium text-gray-700 mb-2">Descripción</h4>
                            <p class="text-sm text-gray-600">Producto auténtico con códigos QR únicos para verificación de autenticidad. Cada unidad cuenta con un identificador irrepetible que garantiza su originalidad.</p>
                            ${productData.warrantyPolicy ? `
                                <div class="mt-3 pt-3 border-t border-gray-200">
                                    <a href="${productData.warrantyPolicy}" target="_blank" 
                                       class="inline-flex items-center text-blue-600 hover:text-blue-800 text-sm font-medium">
                                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                        </svg>
                                        Ver Política de Garantía
                                    </a>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        function getManufacturerTabContent() {
            const manufacturer = productData.manufacturer || {};
            return `
                <div class="space-y-6">
                    <div class="flex items-center space-x-4">
                        <div class="w-16 h-16 bg-blue-100 rounded-xl flex items-center justify-center">
                            <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                            </svg>
                        </div>
                        <div>
                            <h3 class="text-xl font-medium text-gray-900">${manufacturer.name || 'N/A'}</h3>
                            <p class="text-gray-500">${manufacturer.city || 'N/A'}, ${manufacturer.country || 'N/A'}</p>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="space-y-4">
                            <div>
                                <span class="text-gray-500">Fundado en:</span>
                                <span class="ml-2 font-medium text-gray-900">${manufacturer.established || 'N/A'}</span>
                            </div>
                            <div>
                                <span class="text-gray-500">Empleados:</span>
                                <span class="ml-2 font-medium text-gray-900">${manufacturer.employees || 'N/A'}</span>
                            </div>
                            <div>
                                <span class="text-gray-500">Teléfono:</span>
                                <span class="ml-2 font-medium text-gray-900">${manufacturer.contact?.phone || 'N/A'}</span>
                            </div>
                            <div>
                                <span class="text-gray-500">Email:</span>
                                <span class="ml-2 font-medium text-gray-900">${manufacturer.contact?.email || 'N/A'}</span>
                            </div>
                        </div>
                        
                        <div>
                            <h4 class="text-lg font-medium text-gray-900 mb-3">Certificaciones</h4>
                            <div class="space-y-2">
                                ${(manufacturer.certifications || []).map(cert => `
                                    <div class="flex items-center">
                                        <svg class="w-4 h-4 text-green-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                        <span class="text-sm text-gray-700">${cert}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function getMaterialsTabContent() {
            const materials = productData.materials || {};
            return `
                <div class="space-y-6">
                    <div>
                        <h3 class="text-lg font-medium text-gray-900 mb-3">Material Principal</h3>
                        <p class="text-gray-600">${materials.primary || 'N/A'}</p>
                    </div>
                    
                    <div>
                        <h3 class="text-lg font-medium text-gray-900 mb-3">Materiales Secundarios</h3>
                        <div class="space-y-2">
                            ${(materials.secondary || []).map(material => `
                                <div class="flex items-center">
                                    <svg class="w-4 h-4 text-blue-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                    </svg>
                                    <span class="text-sm text-gray-700">${material}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        function getCareTabContent() {
            const care = productData.care || {};
            return `
                <div class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <h3 class="text-lg font-medium text-green-700 mb-3">Recomendaciones de Uso</h3>
                            <div class="space-y-2">
                                ${(care.usage?.recommendations || []).map(rec => `
                                    <div class="flex items-start">
                                        <svg class="w-4 h-4 text-green-500 mr-2 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                        <span class="text-sm text-gray-700">${rec}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <div>
                            <h3 class="text-lg font-medium text-red-700 mb-3">Advertencias</h3>
                            <div class="space-y-2">
                                ${(care.usage?.warnings || []).map(warning => `
                                    <div class="flex items-start">
                                        <svg class="w-4 h-4 text-red-500 mr-2 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                                        </svg>
                                        <span class="text-sm text-gray-700">${warning}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function getSustainabilityTabContent() {
            const sustainability = productData.sustainability || {};
            return `
                <div class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-green-50 border border-green-200 p-4 rounded-xl">
                            <div class="flex items-center mb-3">
                                <svg class="w-6 h-6 text-green-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                <h3 class="text-lg font-medium text-green-800">Impacto Ambiental</h3>
                            </div>
                            <p class="text-sm text-green-700">${sustainability.environmental || 'N/A'}</p>
                        </div>
                        
                        <div class="bg-blue-50 border border-blue-200 p-4 rounded-xl">
                            <div class="flex items-center mb-3">
                                <svg class="w-6 h-6 text-blue-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                                </svg>
                                <h3 class="text-lg font-medium text-blue-800">Impacto Social</h3>
                            </div>
                            <p class="text-sm text-blue-700">${sustainability.social || 'N/A'}</p>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderProductStats() {
            const totalItems = allItems.length;
            const claimedItems = allItems.filter(item => item.ownerId).length;
            const availableItems = totalItems - claimedItems;
            const claimedPercentage = totalItems > 0 ? Math.round((claimedItems / totalItems) * 100) : 0;

            document.getElementById('product-stats').innerHTML = `
                <div class="glass-card rounded-2xl p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-500">Total IDs</p>
                            <p class="text-3xl font-light text-gray-900">${totalItems}</p>
                        </div>
                        <div class="w-12 h-12 bg-gray-100 rounded-xl flex items-center justify-center">
                            <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 20l4-16m2 16l4-16M6 9h14M4 15h14"></path>
                            </svg>
                        </div>
                    </div>
                </div>
                <div class="glass-card rounded-2xl p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-500">Verificados</p>
                            <p class="text-3xl font-light text-gray-900">${claimedItems}</p>
                        </div>
                        <div class="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center">
                            <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                    </div>
                </div>
                <div class="glass-card rounded-2xl p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-500">Disponibles</p>
                            <p class="text-3xl font-light text-gray-900">${availableItems}</p>
                        </div>
                        <div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center">
                            <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                            </svg>
                        </div>
                    </div>
                </div>
                <div class="glass-card rounded-2xl p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-500">Tasa Verificación</p>
                            <p class="text-3xl font-light text-gray-900">${claimedPercentage}%</p>
                        </div>
                        <div class="w-12 h-12 bg-purple-100 rounded-xl flex items-center justify-center">
                            <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                            </svg>
                        </div>
                    </div>
                </div>
            `;
        }

        function groupItemsIntoBatches(items) {
            const batchMap = {};
            items.forEach(item => {
                const batchId = item.batchId || 'default';
                if (!batchMap[batchId]) {
                    batchMap[batchId] = {
                        id: batchId,
                        items: [],
                        createdAt: item.createdAt || new Date().toISOString(),
                        description: item.batchDescription || 'Lote sin descripción'
                    };
                }
                batchMap[batchId].items.push(item);
            });
            return Object.values(batchMap);
        }

        function renderBatchesView() {
            const container = document.getElementById('batches-container');
            if (batches.length === 0) {
                container.innerHTML = `
                    <div class="p-8 text-center text-gray-500">
                        <svg class="w-12 h-12 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 009.586 13H7"></path>
                        </svg>
                        <p class="font-light">No hay lotes generados para este producto</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = batches.map(batch => {
                const claimedCount = batch.items.filter(item => item.ownerId).length;
                const availableCount = batch.items.length - claimedCount;
                const claimedPercentage = Math.round((claimedCount / batch.items.length) * 100);
                
                return `
                    <div class="border-b border-gray-100 last:border-b-0">
                        <div class="px-8 py-6 hover:bg-gray-50 transition-colors">
                            <div class="flex items-center justify-between">
                                <div class="flex-1">
                                    <div class="flex items-center space-x-4">
                                        <div class="w-12 h-12 bg-gray-100 rounded-xl flex items-center justify-center">
                                            <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 009.586 13H7"></path>
                                            </svg>
                                        </div>
                                        <div>
                                            <h4 class="text-lg font-medium text-gray-900">Lote ${batch.id}</h4>
                                            <p class="text-sm text-gray-500">${batch.description}</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="flex items-center space-x-6">
                                    <div class="text-center">
                                        <p class="text-2xl font-light text-gray-900">${batch.items.length}</p>
                                        <p class="text-xs text-gray-500">Total IDs</p>
                                    </div>
                                    <div class="text-center">
                                        <p class="text-2xl font-light text-green-600">${claimedCount}</p>
                                        <p class="text-xs text-gray-500">Verificados</p>
                                    </div>
                                    <div class="text-center">
                                        <p class="text-2xl font-light text-blue-600">${availableCount}</p>
                                        <p class="text-xs text-gray-500">Disponibles</p>
                                    </div>
                                    <div class="text-center">
                                        <p class="text-2xl font-light text-purple-600">${claimedPercentage}%</p>
                                        <p class="text-xs text-gray-500">Tasa</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderItemsTable(items) {
            const tbody = document.getElementById('ids-table-body');
            const noItemsMessage = document.getElementById('no-ids-message');
            
            if (items.length === 0) {
                tbody.innerHTML = '';
                noItemsMessage.classList.remove('hidden');
                return;
            }
            
            noItemsMessage.classList.add('hidden');
            tbody.innerHTML = items.map(item => {
                const client = item.client;
                const statusClass = item.ownerId ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800';
                const statusText = item.ownerId ? 'Verificado' : 'Disponible';
                
                return `
                    <tr class="hover:bg-gray-50 transition-colors">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="font-mono text-sm text-gray-900">${item.id}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-900">${item.batchId || 'default'}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">
                                ${statusText}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-900">
                                ${client ? client.name : 'Sin asignar'}
                            </div>
                            ${client ? `<div class="text-sm text-gray-500">${client.email}</div>` : ''}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            ${new Date(item.createdAt || new Date()).toLocaleDateString()}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button onclick="copyToClipboard('${item.id}')" 
                                    class="text-gray-400 hover:text-gray-600 mr-3">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                </svg>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Secure ID Generation (Level 3)
        async function generateSecureID(productName, clientCode = 'WM') {
            const year = new Date().getFullYear();
            const timestamp = Date.now();
            const random = Math.random().toString(36).substring(2, 8).toUpperCase();
            
            // Create unique string for hashing
            const uniqueString = `${productName}-${clientCode}-${timestamp}-${random}-${Math.random()}`;
            
            // Generate SHA-256 hash
            const encoder = new TextEncoder();
            const data = encoder.encode(uniqueString);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            
            // Take first 8 characters of hash for readability
            const secureHash = hashHex.substring(0, 8).toUpperCase();
            
            return `AUT-${year}-${clientCode}-${secureHash}`;
        }

        function setupEventListeners() {
            // View mode toggle
            document.getElementById('view-mode').addEventListener('change', (e) => {
                currentViewMode = e.target.value;
                if (currentViewMode === 'batches') {
                    document.getElementById('batches-view').classList.remove('hidden');
                    document.getElementById('ids-view').classList.add('hidden');
                } else {
                    document.getElementById('batches-view').classList.add('hidden');
                    document.getElementById('ids-view').classList.remove('hidden');
                }
            });

            // Filter toggle
            document.getElementById('toggle-filters').addEventListener('click', () => {
                const content = document.getElementById('filters-content');
                const button = document.getElementById('toggle-filters');
                if (content.classList.contains('hidden')) {
                    content.classList.remove('hidden');
                    button.textContent = 'Ocultar';
                } else {
                    content.classList.add('hidden');
                    button.textContent = 'Mostrar';
                }
            });

            // Batch generation
            document.getElementById('generate-batch-btn').addEventListener('click', openBatchModal);
            document.getElementById('close-batch-modal').addEventListener('click', closeBatchModal);
            document.getElementById('confirm-batch-btn').addEventListener('click', generateBatch);
            
            // Product editing
            document.getElementById('edit-product-btn').addEventListener('click', toggleEditMode);
            document.getElementById('save-changes-btn').addEventListener('click', saveProductChanges);
            document.getElementById('cancel-edit-btn').addEventListener('click', cancelEdit);
        }

        function openBatchModal() {
            document.getElementById('batch-product-name').textContent = productData.productName;
            document.getElementById('batch-modal').classList.remove('hidden');
        }

        function closeBatchModal() {
            document.getElementById('batch-modal').classList.add('hidden');
            document.getElementById('batch-quantity').value = '10';
            document.getElementById('batch-description').value = '';
        }

        async function generateBatch() {
            const quantity = parseInt(document.getElementById('batch-quantity').value);
            const description = document.getElementById('batch-description').value || `Lote generado el ${new Date().toLocaleDateString()}`;
            
            if (quantity < 1 || quantity > 100) {
                showToast('La cantidad debe estar entre 1 y 100 IDs', 'error');
                return;
            }

            const batchId = `BATCH-${Date.now()}`;
            const newItems = [];
            
            // Show loading state
            const confirmBtn = document.getElementById('confirm-batch-btn');
            confirmBtn.textContent = 'Generando...';
            confirmBtn.disabled = true;
            
            try {
                for (let i = 0; i < quantity; i++) {
                    const secureId = await generateSecureID(productData.productName);
                    newItems.push({
                        id: secureId,
                        batchId: batchId,
                        batchDescription: description,
                        createdAt: new Date().toISOString(),
                        ownerId: null,
                        claimedAt: null,
                        client: null
                    });
                }
                
                // Add to allItems and update batches
                allItems.push(...newItems);
                batches = groupItemsIntoBatches(allItems);
                
                // Re-render everything
                renderProductStats();
                renderBatchesView();
                renderItemsTable(allItems);
                
                closeBatchModal();
                showToast(`Lote de ${quantity} IDs generado correctamente`, 'success');
                
            } catch (error) {
                console.error('Error generating batch:', error);
                showToast('Error al generar el lote', 'error');
            } finally {
                confirmBtn.textContent = 'Generar Lote Seguro';
                confirmBtn.disabled = false;
            }
        }
        
        function toggleEditMode() {
            const editForm = document.getElementById('product-edit-form');
            const productInfo = document.getElementById('product-info');
            
            if (editForm.classList.contains('hidden')) {
                // Show edit form
                editForm.classList.remove('hidden');
                productInfo.classList.add('lg:col-span-1');
                productInfo.classList.remove('lg:col-span-2');
                
                // Populate form with current data
                document.getElementById('edit-name').value = productData.productName;
                document.getElementById('edit-color').value = productData.details?.color || '';
                document.getElementById('edit-material').value = productData.details?.material || '';
                document.getElementById('edit-type').value = productData.details?.tipo || '';
            } else {
                cancelEdit();
            }
        }
        
        function cancelEdit() {
            const editForm = document.getElementById('product-edit-form');
            const productInfo = document.getElementById('product-info');
            
            editForm.classList.add('hidden');
            productInfo.classList.remove('lg:col-span-1');
            productInfo.classList.add('lg:col-span-2');
        }
        
        function saveProductChanges() {
            const newName = document.getElementById('edit-name').value.trim();
            const newColor = document.getElementById('edit-color').value.trim();
            const newMaterial = document.getElementById('edit-material').value.trim();
            const newType = document.getElementById('edit-type').value.trim();
            
            if (!newName) {
                showToast('El nombre del producto es requerido', 'error');
                return;
            }
            
            // Update product data
            productData.productName = newName;
            productData.details = {
                ...productData.details,
                color: newColor,
                material: newMaterial,
                tipo: newType
            };
            
            // Re-render product info
            renderProductInfo();
            cancelEdit();
            showToast('Producto actualizado correctamente', 'success');
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showToast('Copiado al portapapeles');
            });
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toast-message');
            
            toastMessage.textContent = message;
            
            // Update toast styling based on type
            toast.className = 'fixed top-5 right-5 py-3 px-6 rounded-xl shadow-lg z-50';
            if (type === 'success') {
                toast.classList.add('bg-green-600', 'text-white');
            } else if (type === 'error') {
                toast.classList.add('bg-red-600', 'text-white');
            } else {
                toast.classList.add('bg-gray-900', 'text-white');
            }
            
            toast.classList.remove('hidden');
            
            setTimeout(() => {
                toast.classList.add('hidden');
            }, 3000);
        }

        function goBack() {
            window.history.back();
        }

        // Make functions globally available
        window.copyToClipboard = copyToClipboard;
        window.goBack = goBack;
    </script>
</body>
</html>