<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de IDs | Autentikapp</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns@2.28.0/esm/index.js"></script>
</head>
<body class="bg-white text-gray-900 flex">

    <div id="sidebar-placeholder"></div>

    <!-- Main Content -->
    <main class="flex-1 p-6 md:p-10 bg-white">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-6">
            <div>
                <h1 class="text-3xl font-bold">Gestión de IDs</h1>
                <p class="text-lg text-gray-500">Control completo de códigos QR y autenticación.</p>
            </div>
            <div class="flex space-x-3 mt-4 md:mt-0">
                <button id="bulk-actions-btn" class="px-4 py-2 bg-white border border-gray-200 hover:bg-gray-50 text-gray-700 rounded-lg font-medium shadow-sm">
                    Acciones Masivas
                </button>
                <button id="generate-batch-btn" class="px-6 py-3 font-bold text-white bg-[#00a1ff] rounded-lg hover:bg-blue-500 focus:outline-none focus:ring-4 focus:ring-blue-200 transition-all duration-300 shadow-sm">
                    Generar Lote
                </button>
            </div>
        </div>

        <!-- Stats Cards -->
        <div id="ids-stats" class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
            <!-- Stats will be loaded here -->
        </div>

        <!-- Advanced Filter Controls -->
        <div class="mb-6 space-y-4">
            <!-- Primary Filters Row -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <input type="text" id="search-ids" placeholder="Buscar por ID, cliente o producto..."
                       class="px-4 py-3 text-gray-900 bg-white border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#00a1ff] focus:border-transparent shadow-sm">
                <select id="filter-product" class="px-4 py-3 text-gray-900 bg-white border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#00a1ff] focus:border-transparent shadow-sm">
                    <option value="all">Todos los productos</option>
                </select>
                <select id="filter-status" class="px-4 py-3 text-gray-900 bg-white border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#00a1ff] focus:border-transparent shadow-sm">
                    <option value="all">Todos los estados</option>
                    <option value="claimed">Asignados</option>
                    <option value="unclaimed">Disponibles</option>
                </select>
                <select id="filter-client-segment" class="px-4 py-3 text-gray-900 bg-white border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#00a1ff] focus:border-transparent shadow-sm">
                    <option value="all">Todos los segmentos</option>
                </select>
            </div>
            
            <!-- Secondary Filters Row -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-6 gap-4">
                <select id="filter-time-range" class="px-4 py-3 text-gray-900 bg-white border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#00a1ff] focus:border-transparent shadow-sm">
                    <option value="all">Todas las fechas</option>
                    <option value="today">Hoy</option>
                    <option value="week">Esta semana</option>
                    <option value="month">Este mes</option>
                    <option value="quarter">Este trimestre</option>
                </select>
                <input type="date" id="date-from" placeholder="Desde" 
                       class="px-4 py-3 text-gray-900 bg-white border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#00a1ff] focus:border-transparent shadow-sm">
                <input type="date" id="date-to" placeholder="Hasta" 
                       class="px-4 py-3 text-gray-900 bg-white border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#00a1ff] focus:border-transparent shadow-sm">
                <select id="filter-country" class="px-4 py-3 text-gray-900 bg-white border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#00a1ff] focus:border-transparent shadow-sm">
                    <option value="all">Todos los países</option>
                </select>
                <select id="sort-ids" class="px-4 py-3 text-gray-900 bg-white border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#00a1ff] focus:border-transparent shadow-sm">
                    <option value="id">Ordenar por ID</option>
                    <option value="creation">Por fecha creación</option>
                    <option value="claimed">Por fecha reclamo</option>
                    <option value="product">Por producto</option>
                    <option value="client">Por cliente</option>
                </select>
                <button id="export-filtered" class="px-4 py-3 bg-green-500 hover:bg-green-600 text-white rounded-lg font-medium shadow-sm">
                    Exportar
                </button>
            </div>
            
            <!-- Filter Summary and Actions -->
            <div class="flex items-center justify-between bg-gray-50 rounded-lg p-3 border border-gray-200">
                <div class="flex items-center space-x-4">
                    <div id="filter-summary" class="text-sm text-gray-600">
                        Mostrando todos los IDs
                    </div>
                    <div class="flex items-center space-x-2">
                        <input type="checkbox" id="select-all" class="rounded">
                        <label for="select-all" class="text-sm text-gray-600">Seleccionar todos</label>
                    </div>
                </div>
                <div class="flex space-x-2">
                    <span id="selected-count" class="text-sm text-blue-600 hidden">0 seleccionados</span>
                    <button id="clear-filters" class="text-sm text-blue-600 hover:text-blue-700 underline">
                        Limpiar filtros
                    </button>
                </div>
            </div>
        </div>

        <!-- IDs Table -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left">
                                <input type="checkbox" id="header-checkbox" class="rounded">
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID del Producto</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Producto</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estado</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cliente</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ubicación</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha Creación</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha Asignación</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="ids-table-body" class="bg-white divide-y divide-gray-200">
                        <!-- ID rows will be inserted here -->
                    </tbody>
                </table>
            </div>
            <div id="no-ids-message" class="p-4 text-center text-gray-500 hidden">No se encontraron IDs.</div>
        </div>

        <!-- Pagination -->
        <div class="flex items-center justify-between mt-6">
            <div class="text-sm text-gray-600">
                <span id="pagination-info">Mostrando 1-50 de 100 IDs</span>
            </div>
            <div class="flex space-x-2">
                <button id="prev-page" class="px-3 py-2 bg-white border border-gray-200 text-gray-600 rounded hover:bg-gray-50 disabled:opacity-50 shadow-sm">
                    Anterior
                </button>
                <div id="page-numbers" class="flex space-x-1">
                    <!-- Page numbers will be inserted here -->
                </div>
                <button id="next-page" class="px-3 py-2 bg-white border border-gray-200 text-gray-600 rounded hover:bg-gray-50 disabled:opacity-50 shadow-sm">
                    Siguiente
                </button>
            </div>
        </div>
    </main>

    <!-- Generate Batch Modal -->
    <div id="batch-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-md">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">Generar Lote de QRs</h2>
                <button id="close-batch-modal" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <form id="batch-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Producto</label>
                    <select id="batch-product" required class="w-full px-3 py-2 text-gray-900 bg-white border border-gray-200 rounded-md focus:outline-none focus:ring-2 focus:ring-[#00a1ff] focus:border-transparent shadow-sm">
                        <option value="">Seleccionar producto</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Cantidad de QRs</label>
                    <input type="number" id="batch-quantity" min="1" max="1000" required class="w-full px-3 py-2 text-gray-900 bg-white border border-gray-200 rounded-md focus:outline-none focus:ring-2 focus:ring-[#00a1ff] focus:border-transparent shadow-sm">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Prefijo personalizado (opcional)</label>
                    <input type="text" id="batch-prefix" placeholder="Ej: LOTE2025" class="w-full px-3 py-2 text-gray-900 bg-white border border-gray-200 rounded-md focus:outline-none focus:ring-2 focus:ring-[#00a1ff] focus:border-transparent shadow-sm">
                </div>
                <div class="flex space-x-4 pt-4">
                    <button type="submit" class="flex-1 px-4 py-2 bg-[#00a1ff] text-white font-medium rounded-md hover:bg-blue-500 shadow-sm">
                        Generar Lote
                    </button>
                    <button type="button" id="cancel-batch" class="flex-1 px-4 py-2 bg-white border border-gray-200 text-gray-700 rounded-md hover:bg-gray-50 shadow-sm">
                        Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Bulk Actions Modal -->
    <div id="bulk-actions-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-md">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">Acciones Masivas</h2>
                <button id="close-bulk-modal" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div class="space-y-4">
                <button onclick="bulkExport()" class="w-full px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg shadow-sm">
                    Exportar Seleccionados
                </button>
                <button onclick="bulkDeactivate()" class="w-full px-4 py-2 bg-yellow-500 hover:bg-yellow-600 text-white rounded-lg shadow-sm">
                    Desactivar Seleccionados
                </button>
                <button onclick="bulkDelete()" class="w-full px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg shadow-sm">
                    Eliminar Seleccionados
                </button>
                <button onclick="bulkReassign()" class="w-full px-4 py-2 bg-purple-500 hover:bg-purple-600 text-white rounded-lg shadow-sm">
                    Reasignar Seleccionados
                </button>
            </div>
        </div>
    </div>

    <!-- ID Detail Modal -->
    <div id="id-detail-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-4xl max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">Detalles del ID</h2>
                <button id="close-id-detail-modal" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div id="id-detail-content">
                <!-- ID detail content will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Assign Client Modal -->
    <div id="assign-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">Asignar Cliente</h2>
                <button id="close-assign-modal" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <div class="mb-6">
                <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 mb-4">
                    <h3 class="font-semibold mb-2">ID del Producto</h3>
                    <span id="assign-id-display" class="font-mono text-sm text-gray-600"></span>
                </div>
            </div>

            <div class="space-y-6">
                <!-- Search Existing Client -->
                <div>
                    <h3 class="text-lg font-semibold mb-4">Buscar Cliente Existente</h3>
                    <div class="space-y-4">
                        <input type="text" id="client-search" placeholder="Buscar por nombre, email o teléfono..."
                               class="w-full px-4 py-3 text-gray-900 bg-white border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#00a1ff] focus:border-transparent shadow-sm">
                        
                        <div id="client-search-results" class="space-y-2 max-h-60 overflow-y-auto hidden">
                            <!-- Search results will appear here -->
                        </div>
                        
                        <div id="selected-client" class="bg-blue-50 border border-blue-200 rounded-lg p-4 hidden">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h4 class="font-semibold text-blue-900">Cliente Seleccionado</h4>
                                    <div id="selected-client-info" class="text-sm text-blue-700 mt-1">
                                        <!-- Selected client info -->
                                    </div>
                                </div>
                                <button id="clear-selection" class="text-blue-600 hover:text-blue-800 text-sm underline">
                                    Cambiar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Divider -->
                <div class="relative">
                    <div class="absolute inset-0 flex items-center">
                        <div class="w-full border-t border-gray-200"></div>
                    </div>
                    <div class="relative flex justify-center text-sm">
                        <span class="px-2 bg-white text-gray-500">o</span>
                    </div>
                </div>

                <!-- Create New Client -->
                <div>
                    <h3 class="text-lg font-semibold mb-4">Crear Nuevo Cliente</h3>
                    <form id="new-client-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nombre Completo *</label>
                            <input type="text" id="new-client-name" required 
                                   class="w-full px-3 py-2 text-gray-900 bg-white border border-gray-200 rounded-md focus:outline-none focus:ring-2 focus:ring-[#00a1ff] focus:border-transparent shadow-sm">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Email *</label>
                            <input type="email" id="new-client-email" required 
                                   class="w-full px-3 py-2 text-gray-900 bg-white border border-gray-200 rounded-md focus:outline-none focus:ring-2 focus:ring-[#00a1ff] focus:border-transparent shadow-sm">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Teléfono *</label>
                            <input type="tel" id="new-client-phone" required 
                                   class="w-full px-3 py-2 text-gray-900 bg-white border border-gray-200 rounded-md focus:outline-none focus:ring-2 focus:ring-[#00a1ff] focus:border-transparent shadow-sm">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Identificación</label>
                            <input type="text" id="new-client-id" 
                                   class="w-full px-3 py-2 text-gray-900 bg-white border border-gray-200 rounded-md focus:outline-none focus:ring-2 focus:ring-[#00a1ff] focus:border-transparent shadow-sm">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Ciudad *</label>
                            <input type="text" id="new-client-city" required 
                                   class="w-full px-3 py-2 text-gray-900 bg-white border border-gray-200 rounded-md focus:outline-none focus:ring-2 focus:ring-[#00a1ff] focus:border-transparent shadow-sm">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">País *</label>
                            <select id="new-client-country" required 
                                    class="w-full px-3 py-2 text-gray-900 bg-white border border-gray-200 rounded-md focus:outline-none focus:ring-2 focus:ring-[#00a1ff] focus:border-transparent shadow-sm">
                                <option value="">Seleccionar país</option>
                                <option value="Colombia">Colombia</option>
                                <option value="España">España</option>
                                <option value="México">México</option>
                                <option value="Argentina">Argentina</option>
                                <option value="Perú">Perú</option>
                                <option value="Chile">Chile</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Edad</label>
                            <input type="number" id="new-client-age" min="18" max="100" 
                                   class="w-full px-3 py-2 text-gray-900 bg-white border border-gray-200 rounded-md focus:outline-none focus:ring-2 focus:ring-[#00a1ff] focus:border-transparent shadow-sm">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Segmento</label>
                            <select id="new-client-segment" 
                                    class="w-full px-3 py-2 text-gray-900 bg-white border border-gray-200 rounded-md focus:outline-none focus:ring-2 focus:ring-[#00a1ff] focus:border-transparent shadow-sm">
                                <option value="Coleccionista">Coleccionista</option>
                                <option value="Amante de la moda">Amante de la moda</option>
                                <option value="Comprador Ocasional">Comprador Ocasional</option>
                                <option value="Cazador de Tendencias">Cazador de Tendencias</option>
                            </select>
                        </div>
                    </form>
                </div>

                <!-- Action Buttons -->
                <div class="flex space-x-4 pt-6 border-t border-gray-200">
                    <button id="confirm-assignment" class="flex-1 px-6 py-3 bg-[#00a1ff] text-white font-medium rounded-lg hover:bg-blue-500 shadow-sm disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        Confirmar Asignación
                    </button>
                    <button id="cancel-assignment" class="flex-1 px-6 py-3 bg-white border border-gray-200 text-gray-700 font-medium rounded-lg hover:bg-gray-50 shadow-sm">
                        Cancelar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast-notification" class="fixed top-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg hidden z-50">
        <span id="toast-message">Acción completada</span>
    </div>

    <script type="module" src="./js/loadSidebar.js"></script>
    <script>
        // Check authentication
        if (localStorage.getItem('autentikapp_session') !== 'authenticated') {
            window.location.href = 'login.html';
        }
    </script>
    <script type="module">
        import { parseISO, format, subDays, subMonths } from 'https://cdn.jsdelivr.net/npm/date-fns@2.28.0/esm/index.js';

        let allIdsData = [];
        let allClientsData = [];
        let allProductsData = [];
        let filteredIds = [];
        let selectedIds = new Set();
        let currentPage = 1;
        const itemsPerPage = 50;
        let currentAssignId = null;
        let selectedClientForAssignment = null;

        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            setupEventListeners();
        });

        function loadData() {
            fetch('business.json')
                .then(response => response.json())
                .then(data => {
                    allClientsData = data.clients;
                    allProductsData = data.products;
                    
                    // Create flat array of all IDs with product and client info
                    allIdsData = [];
                    data.products.forEach(product => {
                        product.items.forEach(item => {
                            const client = data.clients.find(c => c.id === item.ownerId);
                            allIdsData.push({
                                ...item,
                                productName: product.productName,
                                productImage: product.productImage,
                                productDetails: product.details,
                                client: client || null
                            });
                        });
                    });

                    renderStats();
                    populateFilters();
                    filterIds();
                })
                .catch(error => {
                    console.error("Error al cargar los datos:", error);
                    document.getElementById('no-ids-message').classList.remove('hidden');
                });
        }

        function setupEventListeners() {
            // Filter events
            document.getElementById('search-ids').addEventListener('input', filterIds);
            document.getElementById('filter-product').addEventListener('change', filterIds);
            document.getElementById('filter-status').addEventListener('change', filterIds);
            document.getElementById('filter-client-segment').addEventListener('change', filterIds);
            document.getElementById('filter-time-range').addEventListener('change', filterIds);
            document.getElementById('date-from').addEventListener('change', filterIds);
            document.getElementById('date-to').addEventListener('change', filterIds);
            document.getElementById('filter-country').addEventListener('change', filterIds);
            document.getElementById('sort-ids').addEventListener('change', filterIds);

            // Action buttons
            document.getElementById('generate-batch-btn').addEventListener('click', () => {
                document.getElementById('batch-modal').classList.remove('hidden');
            });
            document.getElementById('bulk-actions-btn').addEventListener('click', () => {
                document.getElementById('bulk-actions-modal').classList.remove('hidden');
            });
            document.getElementById('clear-filters').addEventListener('click', clearAllFilters);
            document.getElementById('export-filtered').addEventListener('click', exportFiltered);

            // Modal events
            setupModalEvents();
            
            // Selection events
            document.getElementById('select-all').addEventListener('change', toggleSelectAll);
            document.getElementById('header-checkbox').addEventListener('change', toggleSelectAll);
        }

        function setupModalEvents() {
            // Batch modal
            document.getElementById('close-batch-modal').addEventListener('click', () => {
                document.getElementById('batch-modal').classList.add('hidden');
            });
            document.getElementById('cancel-batch').addEventListener('click', () => {
                document.getElementById('batch-modal').classList.add('hidden');
            });
            document.getElementById('batch-form').addEventListener('submit', generateBatch);

            // Bulk actions modal
            document.getElementById('close-bulk-modal').addEventListener('click', () => {
                document.getElementById('bulk-actions-modal').classList.add('hidden');
            });

            // ID detail modal
            document.getElementById('close-id-detail-modal').addEventListener('click', () => {
                document.getElementById('id-detail-modal').classList.add('hidden');
            });

            // Assignment modal
            document.getElementById('close-assign-modal').addEventListener('click', () => {
                document.getElementById('assign-modal').classList.add('hidden');
            });
            document.getElementById('cancel-assignment').addEventListener('click', () => {
                document.getElementById('assign-modal').classList.add('hidden');
            });
            document.getElementById('client-search').addEventListener('input', searchClients);
            document.getElementById('clear-selection').addEventListener('click', clearClientSelection);
            document.getElementById('confirm-assignment').addEventListener('click', confirmAssignment);
            
            // New client form validation
            const newClientInputs = ['new-client-name', 'new-client-email', 'new-client-phone', 'new-client-city', 'new-client-country'];
            newClientInputs.forEach(inputId => {
                document.getElementById(inputId).addEventListener('input', validateAssignmentForm);
            });
        }

        function renderStats() {
            const totalIds = allIdsData.length;
            const claimedIds = allIdsData.filter(id => id.status === 'Claimed').length;
            const availableIds = totalIds - claimedIds;
            const claimRate = totalIds > 0 ? ((claimedIds / totalIds) * 100).toFixed(1) : 0;
            const uniqueProducts = new Set(allIdsData.map(id => id.productName)).size;

            const statsContainer = document.getElementById('ids-stats');
            statsContainer.innerHTML = `
                <div class="bg-white border border-gray-200 p-4 rounded-lg text-center shadow-sm">
                    <h4 class="text-gray-500 text-sm font-medium">Total IDs</h4>
                    <p class="text-2xl font-bold mt-1">${totalIds}</p>
                </div>
                <div class="bg-white border border-gray-200 p-4 rounded-lg text-center shadow-sm">
                    <h4 class="text-gray-500 text-sm font-medium">Asignados</h4>
                    <p class="text-2xl font-bold mt-1 text-green-600">${claimedIds}</p>
                </div>
                <div class="bg-white border border-gray-200 p-4 rounded-lg text-center shadow-sm">
                    <h4 class="text-gray-500 text-sm font-medium">Disponibles</h4>
                    <p class="text-2xl font-bold mt-1 text-blue-600">${availableIds}</p>
                </div>
                <div class="bg-white border border-gray-200 p-4 rounded-lg text-center shadow-sm">
                    <h4 class="text-gray-500 text-sm font-medium">Tasa Asignación</h4>
                    <p class="text-2xl font-bold mt-1">${claimRate}%</p>
                </div>
                <div class="bg-white border border-gray-200 p-4 rounded-lg text-center shadow-sm">
                    <h4 class="text-gray-500 text-sm font-medium">Productos</h4>
                    <p class="text-2xl font-bold mt-1">${uniqueProducts}</p>
                </div>
            `;
        }

        function populateFilters() {
            // Populate product filter
            const productFilter = document.getElementById('filter-product');
            const batchProduct = document.getElementById('batch-product');
            const products = [...new Set(allIdsData.map(id => id.productName))].sort();
            
            products.forEach(product => {
                const option1 = document.createElement('option');
                option1.value = product;
                option1.textContent = product;
                productFilter.appendChild(option1);

                const option2 = document.createElement('option');
                option2.value = product;
                option2.textContent = product;
                batchProduct.appendChild(option2);
            });

            // Populate segment filter
            const segmentFilter = document.getElementById('filter-client-segment');
            const segments = [...new Set(allClientsData.map(client => client.segment))].sort();
            segments.forEach(segment => {
                const option = document.createElement('option');
                option.value = segment;
                option.textContent = segment;
                segmentFilter.appendChild(option);
            });

            // Populate country filter
            const countryFilter = document.getElementById('filter-country');
            const countries = [...new Set(allClientsData.map(client => client.country))].sort();
            countries.forEach(country => {
                const option = document.createElement('option');
                option.value = country;
                option.textContent = country;
                countryFilter.appendChild(option);
            });
        }

        function filterIds() {
            const searchTerm = document.getElementById('search-ids').value.toLowerCase();
            const productFilter = document.getElementById('filter-product').value;
            const statusFilter = document.getElementById('filter-status').value;
            const segmentFilter = document.getElementById('filter-client-segment').value;
            const timeRangeFilter = document.getElementById('filter-time-range').value;
            const dateFrom = document.getElementById('date-from').value;
            const dateTo = document.getElementById('date-to').value;
            const countryFilter = document.getElementById('filter-country').value;
            const sortBy = document.getElementById('sort-ids').value;

            filteredIds = allIdsData.filter(id => {
                const matchesSearch = id.id.toLowerCase().includes(searchTerm) ||
                                    id.productName.toLowerCase().includes(searchTerm) ||
                                    (id.client && id.client.name.toLowerCase().includes(searchTerm));
                
                const matchesProduct = productFilter === 'all' || id.productName === productFilter;
                const matchesStatus = statusFilter === 'all' || 
                                    (statusFilter === 'claimed' && id.status === 'Claimed') ||
                                    (statusFilter === 'unclaimed' && id.status !== 'Claimed');
                
                const matchesSegment = segmentFilter === 'all' || 
                                     (id.client && id.client.segment === segmentFilter);
                
                const matchesCountry = countryFilter === 'all' || 
                                     (id.client && id.client.country === countryFilter);

                // Time filter
                let matchesTime = true;
                if (id.creationDate && timeRangeFilter !== 'all') {
                    const creationDate = parseISO(id.creationDate);
                    const today = new Date();
                    
                    switch(timeRangeFilter) {
                        case 'today':
                            matchesTime = format(creationDate, 'yyyy-MM-dd') === format(today, 'yyyy-MM-dd');
                            break;
                        case 'week':
                            matchesTime = creationDate >= subDays(today, 7);
                            break;
                        case 'month':
                            matchesTime = creationDate >= subDays(today, 30);
                            break;
                        case 'quarter':
                            matchesTime = creationDate >= subMonths(today, 3);
                            break;
                    }
                }

                // Date range filter
                if (dateFrom && id.creationDate) {
                    const creationDate = parseISO(id.creationDate);
                    const fromDate = parseISO(dateFrom);
                    matchesTime = matchesTime && creationDate >= fromDate;
                }
                if (dateTo && id.creationDate) {
                    const creationDate = parseISO(id.creationDate);
                    const toDate = parseISO(dateTo);
                    matchesTime = matchesTime && creationDate <= toDate;
                }

                return matchesSearch && matchesProduct && matchesStatus && 
                       matchesSegment && matchesCountry && matchesTime;
            });

            // Sort filtered results
            filteredIds.sort((a, b) => {
                switch(sortBy) {
                    case 'id': return a.id.localeCompare(b.id);
                    case 'creation':
                        const dateA = a.creationDate ? parseISO(a.creationDate) : new Date(0);
                        const dateB = b.creationDate ? parseISO(b.creationDate) : new Date(0);
                        return dateB - dateA;
                    case 'claimed':
                        const claimedA = a.claimedDate ? parseISO(a.claimedDate) : new Date(0);
                        const claimedB = b.claimedDate ? parseISO(b.claimedDate) : new Date(0);
                        return claimedB - claimedA;
                    case 'product': return a.productName.localeCompare(b.productName);
                    case 'client': 
                        const clientA = a.client ? a.client.name : 'ZZZ';
                        const clientB = b.client ? b.client.name : 'ZZZ';
                        return clientA.localeCompare(clientB);
                    default: return 0;
                }
            });

            currentPage = 1;
            updateFilterSummary();
            renderIdsTable();
            renderPagination();
        }

        function renderIdsTable() {
            const tableBody = document.getElementById('ids-table-body');
            const noIdsMessage = document.getElementById('no-ids-message');

            if (filteredIds.length === 0) {
                tableBody.innerHTML = '';
                noIdsMessage.classList.remove('hidden');
                return;
            }

            noIdsMessage.classList.add('hidden');
            
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const pageIds = filteredIds.slice(startIndex, endIndex);

            tableBody.innerHTML = pageIds.map(id => {
                const creationDate = id.creationDate ? format(parseISO(id.creationDate), 'dd/MM/yyyy') : 'N/A';
                const claimedDate = id.claimedDate ? format(parseISO(id.claimedDate), 'dd/MM/yyyy') : '-';
                const clientInfo = id.client ? `${id.client.name}` : '-';
                const location = id.client ? `${id.client.city}, ${id.client.country}` : '-';

                return `
                    <tr class="bg-white hover:bg-gray-50 ${selectedIds.has(id.id) ? 'bg-blue-50' : ''}">
                        <td class="px-6 py-4">
                            <input type="checkbox" class="id-checkbox rounded" data-id="${id.id}" 
                                   ${selectedIds.has(id.id) ? 'checked' : ''}>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="font-mono text-sm">${id.id}</span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <img src="${id.productImage}" alt="${id.productName}" class="w-8 h-8 rounded mr-3">
                                <span class="text-sm">${id.productName}</span>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 py-1 text-xs rounded-full ${
                                id.status === 'Claimed' 
                                    ? 'bg-green-900 text-green-300' 
                                    : 'bg-blue-900 text-blue-300'
                            }">
                                ${id.status === 'Claimed' ? 'Asignado' : 'Disponible'}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            ${id.client ? `
                                <button onclick="showClientProfile('${id.client.id}')" 
                                        class="text-blue-600 hover:text-blue-700 hover:underline text-sm">
                                    ${clientInfo}
                                </button>
                            ` : '<span class="text-gray-500 text-sm">-</span>'}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${location}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${creationDate}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${claimedDate}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <div class="flex justify-end space-x-2">
                                <button onclick="showIdDetail('${id.id}')" 
                                        class="bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded text-xs shadow-sm">
                                    Detalles
                                </button>
                                <button onclick="viewQR('${id.id}')" 
                                        class="bg-green-500 hover:bg-green-600 text-white px-2 py-1 rounded text-xs shadow-sm">
                                    Ver QR
                                </button>
                                ${id.status !== 'Claimed' ? `
                                    <button onclick="assignId('${id.id}')" 
                                            class="bg-yellow-500 hover:bg-yellow-600 text-white px-2 py-1 rounded text-xs shadow-sm">
                                        Asignar
                                    </button>
                                ` : ''}
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');

            // Add event listeners to checkboxes
            document.querySelectorAll('.id-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', handleIdSelection);
            });
        }

        function renderPagination() {
            const totalPages = Math.ceil(filteredIds.length / itemsPerPage);
            const startIndex = (currentPage - 1) * itemsPerPage + 1;
            const endIndex = Math.min(currentPage * itemsPerPage, filteredIds.length);

            document.getElementById('pagination-info').textContent = 
                `Mostrando ${startIndex}-${endIndex} de ${filteredIds.length} IDs`;

            const pageNumbers = document.getElementById('page-numbers');
            pageNumbers.innerHTML = '';

            for (let i = Math.max(1, currentPage - 2); i <= Math.min(totalPages, currentPage + 2); i++) {
                const button = document.createElement('button');
                button.textContent = i;
                button.className = `px-3 py-2 rounded ${i === currentPage ? 'bg-blue-600 text-white shadow-sm' : 'bg-white border border-gray-200 text-gray-600 hover:bg-gray-50 shadow-sm'}`;
                button.addEventListener('click', () => {
                    currentPage = i;
                    renderIdsTable();
                    renderPagination();
                });
                pageNumbers.appendChild(button);
            }

            document.getElementById('prev-page').disabled = currentPage === 1;
            document.getElementById('next-page').disabled = currentPage === totalPages;
        }

        function updateFilterSummary() {
            const summary = document.getElementById('filter-summary');
            const total = allIdsData.length;
            const filtered = filteredIds.length;
            
            if (filtered === total) {
                summary.textContent = `Mostrando todos los ${total} IDs`;
            } else {
                summary.textContent = `Mostrando ${filtered} de ${total} IDs`;
            }
        }

        function handleIdSelection(e) {
            const idValue = e.target.dataset.id;
            if (e.target.checked) {
                selectedIds.add(idValue);
            } else {
                selectedIds.delete(idValue);
            }
            updateSelectionUI();
        }

        function toggleSelectAll() {
            const selectAll = document.getElementById('select-all').checked;
            const pageIds = filteredIds.slice((currentPage - 1) * itemsPerPage, currentPage * itemsPerPage);
            
            if (selectAll) {
                pageIds.forEach(id => selectedIds.add(id.id));
            } else {
                pageIds.forEach(id => selectedIds.delete(id.id));
            }
            
            renderIdsTable();
            updateSelectionUI();
        }

        function updateSelectionUI() {
            const selectedCount = document.getElementById('selected-count');
            if (selectedIds.size > 0) {
                selectedCount.textContent = `${selectedIds.size} seleccionados`;
                selectedCount.classList.remove('hidden');
            } else {
                selectedCount.classList.add('hidden');
            }
        }

        function clearAllFilters() {
            document.getElementById('search-ids').value = '';
            document.getElementById('filter-product').value = 'all';
            document.getElementById('filter-status').value = 'all';
            document.getElementById('filter-client-segment').value = 'all';
            document.getElementById('filter-time-range').value = 'all';
            document.getElementById('date-from').value = '';
            document.getElementById('date-to').value = '';
            document.getElementById('filter-country').value = 'all';
            document.getElementById('sort-ids').value = 'id';
            filterIds();
        }

        function generateBatch(e) {
            e.preventDefault();
            const product = document.getElementById('batch-product').value;
            const quantity = parseInt(document.getElementById('batch-quantity').value);
            const prefix = document.getElementById('batch-prefix').value || 'BATCH';
            
            // Generate new IDs (simulation)
            for (let i = 0; i < quantity; i++) {
                const newId = `${prefix}-${Date.now()}-${i}`;
                allIdsData.push({
                    id: newId,
                    status: 'Unclaimed',
                    ownerId: null,
                    claimedDate: null,
                    creationDate: new Date().toISOString().split('T')[0],
                    productName: product,
                    productImage: allProductsData.find(p => p.productName === product)?.productImage || '',
                    client: null
                });
            }
            
            document.getElementById('batch-modal').classList.add('hidden');
            document.getElementById('batch-form').reset();
            renderStats();
            filterIds();
            showToast(`Lote de ${quantity} QRs generado exitosamente`);
        }

        function showToast(message) {
            const toast = document.getElementById('toast-notification');
            const toastMessage = document.getElementById('toast-message');
            
            toastMessage.textContent = message;
            toast.classList.remove('hidden');
            
            setTimeout(() => {
                toast.classList.add('hidden');
            }, 3000);
        }

        // Action functions
        function showIdDetail(idValue) {
            const id = allIdsData.find(item => item.id === idValue);
            if (!id) return;

            const detailContent = document.getElementById('id-detail-content');
            detailContent.innerHTML = `
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-gray-50 border border-gray-200 rounded-lg p-6">
                        <h3 class="text-xl font-semibold mb-4">Información del ID</h3>
                        <div class="space-y-3">
                            <div><span class="text-gray-500">ID:</span> <span class="ml-2 font-mono">${id.id}</span></div>
                            <div><span class="text-gray-500">Producto:</span> <span class="ml-2">${id.productName}</span></div>
                            <div><span class="text-gray-500">Estado:</span> 
                                <span class="ml-2 px-2 py-1 text-xs rounded-full ${
                                    id.status === 'Claimed' ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800'
                                }">
                                    ${id.status === 'Claimed' ? 'Asignado' : 'Disponible'}
                                </span>
                            </div>
                            <div><span class="text-gray-500">Fecha Creación:</span> <span class="ml-2">${id.creationDate ? format(parseISO(id.creationDate), 'dd/MM/yyyy') : 'N/A'}</span></div>
                            ${id.claimedDate ? `<div><span class="text-gray-500">Fecha Asignación:</span> <span class="ml-2">${format(parseISO(id.claimedDate), 'dd/MM/yyyy')}</span></div>` : ''}
                        </div>
                    </div>
                    
                    ${id.client ? `
                        <div class="bg-gray-50 border border-gray-200 rounded-lg p-6">
                            <h3 class="text-xl font-semibold mb-4">Información del Cliente</h3>
                            <div class="space-y-3">
                                <div><span class="text-gray-500">Nombre:</span> <span class="ml-2">${id.client.name}</span></div>
                                <div><span class="text-gray-500">Email:</span> <span class="ml-2">${id.client.email}</span></div>
                                <div><span class="text-gray-500">Teléfono:</span> <span class="ml-2">${id.client.phone}</span></div>
                                <div><span class="text-gray-500">Ubicación:</span> <span class="ml-2">${id.client.city}, ${id.client.country}</span></div>
                                <div><span class="text-gray-500">Segmento:</span> <span class="ml-2">${id.client.segment}</span></div>
                            </div>
                        </div>
                    ` : `
                        <div class="bg-gray-50 border border-gray-200 rounded-lg p-6">
                            <h3 class="text-xl font-semibold mb-4">Sin Cliente Asignado</h3>
                            <p class="text-gray-500">Este ID aún no ha sido asignado a ningún cliente.</p>
                            <button onclick="assignId('${id.id}')" class="mt-4 px-4 py-2 bg-[#00a1ff] text-white rounded-lg hover:bg-blue-500 shadow-sm">
                                Asignar Cliente
                            </button>
                        </div>
                    `}
                </div>
            `;

            document.getElementById('id-detail-modal').classList.remove('hidden');
        }

        function viewQR(idValue) {
            window.open(`verify.html?id=${idValue}`, '_blank');
        }

        function assignId(idValue) {
            currentAssignId = idValue;
            document.getElementById('assign-id-display').textContent = idValue;
            document.getElementById('assign-modal').classList.remove('hidden');
            clearAssignmentForm();
        }

        function showClientProfile(clientId) {
            // This would open the client profile - for now just show a message
            showToast('Abriendo perfil del cliente...');
        }

        function exportFiltered() {
            showToast(`Exportando ${filteredIds.length} IDs filtrados...`);
        }

        // Bulk action functions
        function bulkExport() {
            showToast(`Exportando ${selectedIds.size} IDs seleccionados...`);
            document.getElementById('bulk-actions-modal').classList.add('hidden');
        }

        function bulkDeactivate() {
            if (confirm(`¿Desactivar ${selectedIds.size} IDs seleccionados?`)) {
                showToast(`${selectedIds.size} IDs desactivados`);
                selectedIds.clear();
                updateSelectionUI();
                document.getElementById('bulk-actions-modal').classList.add('hidden');
            }
        }

        function bulkDelete() {
            if (confirm(`¿Eliminar permanentemente ${selectedIds.size} IDs seleccionados?`)) {
                showToast(`${selectedIds.size} IDs eliminados`);
                selectedIds.clear();
                updateSelectionUI();
                document.getElementById('bulk-actions-modal').classList.add('hidden');
            }
        }

        function bulkReassign() {
            showToast(`Función de reasignación masiva para ${selectedIds.size} IDs`);
            document.getElementById('bulk-actions-modal').classList.add('hidden');
        }

        // Assignment functions
        function searchClients() {
            const searchTerm = document.getElementById('client-search').value.toLowerCase().trim();
            const resultsContainer = document.getElementById('client-search-results');
            
            if (searchTerm.length < 2) {
                resultsContainer.classList.add('hidden');
                return;
            }
            
            const matchingClients = allClientsData.filter(client => 
                client.name.toLowerCase().includes(searchTerm) ||
                client.email.toLowerCase().includes(searchTerm) ||
                client.phone.includes(searchTerm)
            ).slice(0, 5);
            
            if (matchingClients.length === 0) {
                resultsContainer.innerHTML = '<div class="p-3 text-gray-500 text-sm">No se encontraron clientes</div>';
                resultsContainer.classList.remove('hidden');
                return;
            }
            
            resultsContainer.innerHTML = matchingClients.map(client => `
                <div class="p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer client-result" 
                     data-client-id="${client.id}">
                    <div class="font-medium">${client.name}</div>
                    <div class="text-sm text-gray-600">${client.email} • ${client.phone}</div>
                    <div class="text-xs text-gray-500">${client.city}, ${client.country} • ${client.segment}</div>
                </div>
            `).join('');
            
            resultsContainer.classList.remove('hidden');
            
            // Add click listeners
            document.querySelectorAll('.client-result').forEach(result => {
                result.addEventListener('click', () => {
                    const clientId = result.dataset.clientId;
                    selectClient(clientId);
                });
            });
        }
        
        function selectClient(clientId) {
            const client = allClientsData.find(c => c.id === clientId);
            if (!client) return;
            
            selectedClientForAssignment = client;
            
            document.getElementById('selected-client-info').innerHTML = `
                <strong>${client.name}</strong><br>
                ${client.email} • ${client.phone}<br>
                ${client.city}, ${client.country} • ${client.segment}
            `;
            
            document.getElementById('selected-client').classList.remove('hidden');
            document.getElementById('client-search-results').classList.add('hidden');
            document.getElementById('client-search').value = client.name;
            
            validateAssignmentForm();
        }
        
        function clearClientSelection() {
            selectedClientForAssignment = null;
            document.getElementById('selected-client').classList.add('hidden');
            document.getElementById('client-search').value = '';
            document.getElementById('client-search-results').classList.add('hidden');
            validateAssignmentForm();
        }
        
        function validateAssignmentForm() {
            const confirmButton = document.getElementById('confirm-assignment');
            
            // Check if client is selected
            if (selectedClientForAssignment) {
                confirmButton.disabled = false;
                return;
            }
            
            // Check if new client form is complete
            const requiredFields = ['new-client-name', 'new-client-email', 'new-client-phone', 'new-client-city', 'new-client-country'];
            const allFilled = requiredFields.every(fieldId => {
                const value = document.getElementById(fieldId).value.trim();
                return value.length > 0;
            });
            
            confirmButton.disabled = !allFilled;
        }
        
        function clearAssignmentForm() {
            selectedClientForAssignment = null;
            document.getElementById('selected-client').classList.add('hidden');
            document.getElementById('client-search').value = '';
            document.getElementById('client-search-results').classList.add('hidden');
            document.getElementById('new-client-form').reset();
            document.getElementById('new-client-segment').value = 'Coleccionista';
            validateAssignmentForm();
        }
        
        function confirmAssignment() {
            if (!currentAssignId) return;
            
            let clientToAssign = selectedClientForAssignment;
            
            // If no existing client selected, create new one
            if (!clientToAssign) {
                const newClientId = 'C' + String(allClientsData.length + 1).padStart(3, '0');
                clientToAssign = {
                    id: newClientId,
                    name: document.getElementById('new-client-name').value.trim(),
                    identification: document.getElementById('new-client-id').value.trim() || newClientId,
                    email: document.getElementById('new-client-email').value.trim(),
                    phone: document.getElementById('new-client-phone').value.trim(),
                    city: document.getElementById('new-client-city').value.trim(),
                    country: document.getElementById('new-client-country').value,
                    age: parseInt(document.getElementById('new-client-age').value) || null,
                    segment: document.getElementById('new-client-segment').value,
                    registrationDate: new Date().toISOString().split('T')[0]
                };
                
                // Add to clients array
                allClientsData.push(clientToAssign);
            }
            
            // Update the ID assignment
            const idToUpdate = allIdsData.find(id => id.id === currentAssignId);
            if (idToUpdate) {
                idToUpdate.status = 'Claimed';
                idToUpdate.ownerId = clientToAssign.id;
                idToUpdate.claimedDate = new Date().toISOString().split('T')[0];
                idToUpdate.client = clientToAssign;
            }
            
            // Close modal and refresh
            document.getElementById('assign-modal').classList.add('hidden');
            renderStats();
            filterIds();
            showToast(`ID ${currentAssignId} asignado exitosamente a ${clientToAssign.name}`);
            
            currentAssignId = null;
        }

        // Make functions global
        window.showIdDetail = showIdDetail;
        window.viewQR = viewQR;
        window.assignId = assignId;
        window.showClientProfile = showClientProfile;
        window.bulkExport = bulkExport;
        window.bulkDeactivate = bulkDeactivate;
        window.bulkDelete = bulkDelete;
        window.bulkReassign = bulkReassign;
    </script>
</body>
</html>